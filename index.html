<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω T√†i Ch√≠nh Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.95);
            --green: #00b894;
            --red: #d63031;
            --dark: #2d3436;
            --text-sub: #636e72;
            --shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.15);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
            margin: 0; padding: 15px;
            min-height: 100vh;
            color: var(--dark);
            display: flex; justify-content: center;
        }

        .app-container { width: 100%; max-width: 800px; }

        .glass-card {
            background: var(--glass);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 20px; margin-bottom: 15px;
        }

        /* HEADER */
        .dashboard-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; }
        .balance-label { font-size: 11px; text-transform: uppercase; color: var(--text-sub); font-weight: 700; }
        .balance-total { font-size: 34px; font-weight: 700; color: #2d3436; line-height: 1; margin: 5px 0; }
        .balance-vnd { font-size: 15px; font-weight: 600; color: #0984e3; }
        
        .badges-row { display: flex; gap: 10px; margin-top: 8px; }
        .badge-info {
            padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 700;
        }
        .bg-profit { background: rgba(0, 184, 148, 0.15); color: var(--green); }
        .bg-loss { background: rgba(214, 48, 49, 0.15); color: var(--red); }
        .bg-vnd { background: rgba(9, 132, 227, 0.1); color: #0984e3; }

        /* INPUTS */
        .modern-input {
            width: 100%; padding: 10px; border: 1px solid #dfe6e9; border-radius: 8px;
            font-size: 14px; outline: none; background: white; font-weight: 600; box-sizing: border-box;
        }
        .modern-input:focus { border-color: #0984e3; }

        /* BUTTONS */
        .quick-bar { display: flex; gap: 8px; align-items: center; margin-top: 10px; }
        .btn {
            border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;
            font-size: 13px; display: flex; align-items: center; justify-content: center; flex: 1; transition: 0.2s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-blue { background: #0984e3; color: white; }
        .btn-flash { background: #fdcb6e; color: #d35400; }
        .btn-undo { background: #b2bec3; color: white; opacity: 0.5; pointer-events: none; }
        .btn-undo.active { opacity: 1; pointer-events: auto; background: #636e72; }

        /* CALENDAR */
        .toggle-bar {
            text-align: center; background: rgba(255,255,255,0.5); padding: 10px; 
            border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 13px; margin-bottom: 15px;
        }
        #calendarSection { display: none; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-nav { background: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-weight: bold; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-header { text-align: center; font-size: 10px; font-weight: 700; color: #b2bec3; margin-bottom: 5px; }

        .day-card {
            background: white; border-radius: 8px; min-height: 55px; padding: 4px; 
            border: 1px solid #f1f2f6; cursor: pointer; position: relative;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .day-card:hover { border-color: #0984e3; transform: translateY(-2px); z-index: 2; }
        .day-card.today { background: #e3f2fd; border-color: #0984e3; }
        
        .val-txt { font-size: 9px; font-weight: 700; text-align: right; display: block; line-height: 1.1; }
        .c-green { color: var(--green); }
        .c-red { color: var(--red); }
        
        /* Loading Status */
        #statusIndicator {
            position: fixed; bottom: 10px; right: 10px; font-size: 10px; 
            background: #2d3436; color: white; padding: 5px 10px; border-radius: 20px; opacity: 0; transition: opacity 0.5s;
        }

        /* MODAL */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center;
        }
        .modal-content { background: white; width: 280px; padding: 25px; border-radius: 15px; }
    </style>
</head>
<body>

<div class="app-container">

    <div class="glass-card">
        <div class="dashboard-header">
            <div style="flex: 1.5;">
                <div class="balance-label">T·ªïng T√†i S·∫£n (V·ªën + L√£i)</div>
                <div class="balance-total" id="totalBalanceDisplay">...</div>
                <div class="balance-vnd" id="vndBalanceDisplay">...</div>
                
                <div class="badges-row">
                    <div id="profitBadge" class="badge-info bg-profit">L√£i: 0</div>
                    <div id="vndProfitBadge" class="badge-info bg-vnd">‚âà 0 ‚Ç´</div>
                </div>
            </div>
            
            <div style="flex: 1; min-width: 120px;">
                <input type="number" id="initialCapital" class="modern-input" placeholder="V·ªën ($)..." onchange="saveConfig()" style="margin-bottom:5px;">
                <input type="number" id="exchangeRate" class="modern-input" value="27000" onchange="saveConfig()">
            </div>
        </div>
    </div>

    <div class="glass-card">
        <div style="display:flex; gap:5px;">
            <input type="number" id="quickIn" class="modern-input" placeholder="+Thu" style="border-color: #55efc4;">
            <input type="number" id="quickOut" class="modern-input" placeholder="-Chi" style="border-color: #fab1a0;">
        </div>
        
        <div class="quick-bar">
            <button class="btn btn-blue" onclick="saveQuick()">L∆∞u</button>
            <button class="btn btn-flash" onclick="spend10()">‚ö° 10$</button>
            <button id="btnUndo" class="btn btn-undo" onclick="execUndo()">‚Ü© Ho√†n t√°c</button>
        </div>
    </div>

    <div class="toggle-bar" onclick="toggleCal()">üìÖ Ch·∫°m ƒë·ªÉ m·ªü L·ªãch S·ª≠</div>

    <div id="calendarSection">
        <div class="glass-card" style="padding: 10px;">
            <div class="calendar-header">
                <button class="cal-nav" onclick="changeMonth(-1)">‚ùÆ</button>
                <span style="font-weight:700; font-size:14px;" id="monthDisplay">12/2025</span>
                <button class="cal-nav" onclick="changeMonth(1)">‚ùØ</button>
            </div>
            
            <div style="text-align:right; margin-bottom:5px;">
                <small onclick="restoreData()" style="color:#0984e3; cursor:pointer; font-size:10px;">üîÑ Kh√¥i ph·ª•c d·ªØ li·ªáu g·ªëc</small>
            </div>

            <div class="calendar-grid" id="calendar"></div>
        </div>
    </div>

</div>

<div id="statusIndicator">ƒêang ƒë·ªìng b·ªô...</div>

<div class="modal-overlay" id="inputModal">
    <div class="modal-content">
        <h4 id="modalTitle" style="margin-top:0; text-align:center;">S·ª≠a giao d·ªãch</h4>
        <input type="number" id="modalIn" class="modern-input" placeholder="Thu ($)" style="margin-bottom:10px;">
        <input type="number" id="modalOut" class="modern-input" placeholder="Chi ($)" style="margin-bottom:15px;">
        <button class="btn btn-blue" onclick="saveModal()">C·∫≠p nh·∫≠t</button>
        <button class="btn" style="width:100%; margin-top:5px; background:#dfe6e9;" onclick="closeModal()">ƒê√≥ng</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // -----------------------------------------------------------
    // ‚ö†Ô∏è B·∫†N H√ÉY D√ÅN CONFIG C·ª¶A B·∫†N V√ÄO KHU V·ª∞C B√äN D∆Ø·ªöI ‚ö†Ô∏è
    // -----------------------------------------------------------
    const firebaseConfig = {
  apiKey: "AIzaSyBk5BR4mtmv1Mcj4gYrbCKLwNiC5fhKlj4",
  authDomain: "thu-nhap-6be80.firebaseapp.com",
  databaseURL: "https://thu-nhap-6be80-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "thu-nhap-6be80",
  storageBucket: "thu-nhap-6be80.firebasestorage.app",
  messagingSenderId: "482191171526",
  appId: "1:482191171526:web:358e486e9d28f194469cc7",
  measurementId: "G-0B436SXQ0P"
};

    // --- KH·ªûI T·∫†O FIREBASE ---
    let app, db;
    try {
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
    } catch(e) {
        console.error("Ch∆∞a c·∫•u h√¨nh Firebase ƒë√∫ng c√°ch!");
        alert("Vui l√≤ng m·ªü file code v√† d√°n Firebase Config v√†o d√≤ng 340!");
    }

    // --- BI·∫æN TO√ÄN C·ª§C ---
    window.dataStore = {}; 
    window.configStore = { cap: 0, rate: 27000 };
    window.undoStack = [];
    window.currentDate = new Date(2025, 11, 1);
    
    // D·ªØ li·ªáu m·∫´u T12
    const SAMPLE_DATA = {
        "2025-12-1": { in: 5, out: 10 }, "2025-12-2": { in: 0, out: 10 }, "2025-12-3": { in: 0, out: 10 },
        "2025-12-4": { in: 0, out: 10 }, "2025-12-5": { in: 0, out: 10 }, "2025-12-6": { in: 0, out: 10 },
        "2025-12-7": { in: 0, out: 10 }, "2025-12-8": { in: 150, out: 10 }, "2025-12-9": { in: 50, out: 10 },
        "2025-12-10": { in: 0, out: 10 }, "2025-12-11": { in: 123, out: 13 }, "2025-12-12": { in: 0, out: 10 },
        "2025-12-13": { in: 96.8, out: 10 }, "2025-12-14": { in: 0, out: 10 }, "2025-12-15": { in: 0, out: 10.6 },
        "2025-12-16": { in: 0, out: 10 }, "2025-12-17": { in: 10, out: 10 }, "2025-12-18": { in: 86, out: 10 },
        "2025-12-19": { in: 90.91, out: 10 }, "2025-12-20": { in: 0, out: 10 }, "2025-12-21": { in: 0, out: 10 },
        "2025-12-22": { in: 0, out: 10 }, "2025-12-23": { in: 0, out: 17 }, "2025-12-24": { in: 42, out: 10 },
        "2025-12-25": { in: 0, out: 10 }, "2025-12-26": { in: 0, out: 10 }, "2025-12-27": { in: 0, out: 10 },
        "2025-12-28": { in: 0, out: 10 }, "2025-12-29": { in: 0, out: 10 }, "2025-12-30": { in: 0, out: 10 },
        "2025-12-31": { in: 0, out: 10 }
    };

    // --- L·∫ÆNG NGHE D·ªÆ LI·ªÜU T·ª™ CLOUD ---
    if(db) {
        showStatus(true);
        // Nghe thay ƒë·ªïi c·∫•u h√¨nh
        onValue(ref(db, 'config'), (snap) => {
            const val = snap.val();
            if(val) {
                window.configStore = val;
                document.getElementById('initialCapital').value = val.cap;
                document.getElementById('exchangeRate').value = val.rate;
                updateCalculations();
            }
        });

        // Nghe thay ƒë·ªïi d·ªØ li·ªáu ch√≠nh
        onValue(ref(db, 'data'), (snap) => {
            const val = snap.val();
            if(val) {
                window.dataStore = val;
            } else {
                // N·∫øu cloud tr·ªëng tr∆°n (l·∫ßn ƒë·∫ßu ch·∫°y), n·∫°p m·∫´u
                window.dataStore = {...SAMPLE_DATA};
                syncToCloud();
            }
            updateCalculations();
            renderCal();
            showStatus(false);
        });
    }

    // --- H√ÄM ƒê·ªíNG B·ªò ---
    function syncToCloud() {
        if(!db) return;
        showStatus(true);
        set(ref(db, 'data'), window.dataStore);
    }

    function syncConfig() {
        if(!db) return;
        set(ref(db, 'config'), window.configStore);
    }

    window.saveConfig = function() {
        window.configStore.cap = parseFloat(document.getElementById('initialCapital').value) || 0;
        window.configStore.rate = parseFloat(document.getElementById('exchangeRate').value) || 27000;
        syncConfig();
        updateCalculations();
    }

    // --- LOGIC GIAO DI·ªÜN ---
    function updateCalculations() {
        let tIn = 0, tOut = 0;
        for (let k in window.dataStore) {
            tIn += parseFloat(window.dataStore[k].in) || 0;
            tOut += parseFloat(window.dataStore[k].out) || 0;
        }
        
        const profit = tIn - tOut;
        const total = window.configStore.cap + profit;
        const rate = window.configStore.rate;

        // Hi·ªÉn th·ªã T·ªïng
        document.getElementById('totalBalanceDisplay').innerText = total.toLocaleString('en-US', {maximumFractionDigits: 2});
        document.getElementById('vndBalanceDisplay').innerText = (total * rate).toLocaleString('vi-VN', {maximumFractionDigits:0}) + ' ‚Ç´';
        
        // Hi·ªÉn th·ªã L√£i
        const pBadge = document.getElementById('profitBadge');
        pBadge.innerText = `L√£i: ${(profit>0?'+':'') + profit.toLocaleString()}`;
        pBadge.className = profit < 0 ? 'badge-info bg-loss' : 'badge-info bg-profit';

        // Hi·ªÉn th·ªã L√£i VND (NEW)
        const pVndBadge = document.getElementById('vndProfitBadge');
        pVndBadge.innerText = `‚âà ${(profit * rate).toLocaleString('vi-VN', {maximumFractionDigits:0})} ‚Ç´`;
        pVndBadge.className = profit < 0 ? 'badge-info bg-loss' : 'badge-info bg-vnd';
    }

    // --- UNDO ---
    function pushUndo() {
        window.undoStack.push(JSON.parse(JSON.stringify(window.dataStore)));
        if(window.undoStack.length > 10) window.undoStack.shift();
        renderUndoBtn();
    }

    window.execUndo = function() {
        if(window.undoStack.length > 0) {
            window.dataStore = window.undoStack.pop();
            syncToCloud();
            renderUndoBtn();
        }
    }

    function renderUndoBtn() {
        const btn = document.getElementById('btnUndo');
        if(window.undoStack.length > 0) {
            btn.classList.add('active');
            btn.innerText = `‚Ü© (${window.undoStack.length})`;
        } else {
            btn.classList.remove('active');
            btn.innerText = `‚Ü© Ho√†n t√°c`;
        }
    }

    // --- ACTIONS ---
    function getToday() { const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }

    window.spend10 = function() {
        pushUndo();
        const k = getToday();
        const cur = window.dataStore[k] || {in:0,out:0};
        window.dataStore[k] = { in: cur.in, out: parseFloat(cur.out) + 10 };
        syncToCloud();
    }

    window.saveQuick = function() {
        const inc = parseFloat(document.getElementById('quickIn').value)||0;
        const exp = parseFloat(document.getElementById('quickOut').value)||0;
        if(inc==0 && exp==0) return;
        
        pushUndo();
        const k = getToday();
        const cur = window.dataStore[k] || {in:0,out:0};
        window.dataStore[k] = { in: parseFloat(cur.in) + inc, out: parseFloat(cur.out) + exp };
        
        document.getElementById('quickIn').value = '';
        document.getElementById('quickOut').value = '';
        syncToCloud();
    }

    window.restoreData = function() {
        if(confirm("D·ªØ li·ªáu tr√™n Cloud s·∫Ω b·ªã ghi ƒë√® b·∫±ng d·ªØ li·ªáu g·ªëc T12?")) {
            pushUndo();
            window.dataStore = {...window.dataStore, ...SAMPLE_DATA};
            syncToCloud();
        }
    }

    // --- CALENDAR RENDER ---
    window.toggleCal = function() {
        const el = document.getElementById('calendarSection');
        el.style.display = (el.style.display==='block')?'none':'block';
    }

    window.changeMonth = function(s) { window.currentDate.setMonth(window.currentDate.getMonth()+s); window.renderCal(); }

    window.renderCal = function() {
        const y = window.currentDate.getFullYear();
        const m = window.currentDate.getMonth();
        document.getElementById('monthDisplay').innerText = `${m+1}/${y}`;
        
        const cal = document.getElementById('calendar');
        cal.innerHTML = '';
        ['CN','T2','T3','T4','T5','T6','T7'].forEach(d => cal.innerHTML+=`<div class="day-header">${d}</div>`);
        
        const firstDay = new Date(y, m, 1).getDay();
        const days = new Date(y, m+1, 0).getDate();

        for(let i=0; i<firstDay; i++) cal.innerHTML += `<div></div>`;

        for(let i=1; i<=days; i++) {
            const k = `${y}-${m+1}-${i}`;
            const d = window.dataStore[k] || {in:0,out:0};
            const isToday = (new Date().toDateString() === new Date(y,m,i).toDateString()) ? 'today' : '';
            
            let htmlVal = '';
            if(d.in > 0) htmlVal += `<span class="val-txt c-green">+${parseFloat(d.in)}</span>`;
            if(d.out > 0) htmlVal += `<span class="val-txt c-red">-${parseFloat(d.out)}</span>`;

            cal.innerHTML += `
            <div class="day-card ${isToday}" onclick="openMod('${k}')">
                <div class="day-num">${i}</div>
                <div>${htmlVal}</div>
            </div>`;
        }
    }

    // --- MODAL ---
    let selKey = null;
    window.openMod = function(k) {
        selKey = k;
        const val = window.dataStore[k] || {in:0,out:0};
        document.getElementById('modalIn').value = val.in||'';
        document.getElementById('modalOut').value = val.out||'';
        document.getElementById('inputModal').style.display = 'flex';
    }
    window.closeModal = function() { document.getElementById('inputModal').style.display = 'none'; }
    window.saveModal = function() {
        pushUndo();
        const inc = parseFloat(document.getElementById('modalIn').value)||0;
        const exp = parseFloat(document.getElementById('modalOut').value)||0;
        if(inc==0 && exp==0) delete window.dataStore[selKey];
        else window.dataStore[selKey] = {in:inc, out:exp};
        syncToCloud(); closeModal();
    }

    function showStatus(show) {
        document.getElementById('statusIndicator').style.opacity = show ? 1 : 0;
    }

    // Init Render
    window.renderCal();
</script>
</body>
</html>