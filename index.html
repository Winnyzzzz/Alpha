<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω T√†i Ch√≠nh Ultimate Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.97);
            --green: #00b894;
            --red: #d63031;
            --blue: #0984e3;
            --purple: #6c5ce7;
            --orange: #fdcb6e;
            --dark: #2d3436;
            --text-sub: #636e72;
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --shadow-sm: 0 4px 12px 0 rgba(0, 0, 0, 0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            margin: 0; 
            padding: 15px;
            min-height: 100vh;
            color: var(--dark);
        }

        .app-container { 
            width: 100%; 
            max-width: 900px; 
            margin: 0 auto;
            position: relative;
        }

        /* HEADER STYLES */
        .app-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
        }

        .app-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            margin: 0 0 5px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .app-subtitle {
            font-size: 12px;
            color: var(--text-sub);
            font-weight: 400;
        }

        .last-sync {
            font-size: 11px;
            color: #636e72;
            margin-top: 5px;
            text-align: center;
        }

        /* GLASS CARD */
        .glass-card {
            background: var(--glass);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 20px; 
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2);
        }

        /* DASHBOARD HEADER */
        .dashboard-header { 
            margin-bottom: 20px; 
            border-bottom: 1px solid #dfe6e9; 
            padding-bottom: 15px; 
        }
        
        .balance-group { 
            margin-bottom: 15px; 
        }
        
        .balance-label { 
            font-size: 11px; 
            text-transform: uppercase; 
            color: var(--text-sub); 
            font-weight: 700; 
            letter-spacing: 0.5px; 
            margin-bottom: 4px;
        }
        
        .balance-total { 
            font-size: 28px; 
            font-weight: 700; 
            color: var(--dark); 
            margin: 0; 
            line-height: 1.2; 
        }
        
        .alpha-box {
            background: rgba(108, 92, 231, 0.1); 
            padding: 15px; 
            border-radius: 12px;
            margin-top: 15px; 
            border: 1px solid rgba(108, 92, 231, 0.2);
        }
        
        .alpha-total { 
            font-size: 20px; 
            font-weight: 700; 
            color: var(--purple); 
            margin: 5px 0;
        }

        .profit-badge {
            display: inline-block; 
            padding: 6px 12px; 
            border-radius: 10px; 
            font-size: 12px; 
            font-weight: 700;
            background: rgba(0, 184, 148, 0.15); 
            color: var(--green); 
            margin-top: 8px;
            border: 1px solid rgba(0, 184, 148, 0.3);
        }
        
        .profit-badge.neg { 
            background: rgba(214, 48, 49, 0.15); 
            color: var(--red); 
            border-color: rgba(214, 48, 49, 0.3);
        }

        /* INPUTS GRID */
        .assets-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px;
            margin-top: 10px;
        }
        
        .input-group { 
            position: relative; 
        }
        
        .input-label { 
            font-size: 10px; 
            font-weight: 700; 
            color: var(--text-sub); 
            margin-bottom: 5px; 
            display: block; 
        }
        
        .modern-input {
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid #dfe6e9; 
            border-radius: 10px;
            font-size: 14px; 
            font-weight: 600; 
            outline: none; 
            background: #fdfdfd; 
            transition: 0.3s;
        }
        
        .modern-input:focus { 
            border-color: var(--blue); 
            background: white; 
            box-shadow: 0 0 0 3px rgba(9, 132, 227, 0.1);
        }
        
        .inp-vnd { 
            border-left: 4px solid var(--green); 
        }
        
        .inp-usd { 
            border-left: 4px solid var(--orange); 
        }
        
        .inp-alpha { 
            border-left: 4px solid var(--purple); 
        }

        /* BUTTONS */
        .input-with-button {
            display: flex; 
            gap: 8px;
            align-items: center;
        }
        
        .input-with-button input {
            flex: 1;
        }
        
        .btn {
            border: none; 
            padding: 10px 15px; 
            border-radius: 10px; 
            font-weight: 600; 
            cursor: pointer;
            font-size: 12px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s;
            gap: 5px;
            white-space: nowrap;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .btn:active { 
            transform: scale(0.98); 
        }
        
        .btn-blue { 
            background: var(--blue); 
            color: white; 
        }
        
        .btn-green { 
            background: var(--green); 
            color: white; 
        }
        
        .btn-red { 
            background: var(--red); 
            color: white; 
        }
        
        .btn-orange { 
            background: var(--orange); 
            color: #d35400; 
        }
        
        .btn-purple { 
            background: var(--purple); 
            color: white; 
        }
        
        .btn-gray { 
            background: #b2bec3; 
            color: white; 
        }
        
        .btn-small {
            padding: 6px 10px;
            font-size: 11px;
            min-width: 40px;
        }

        /* QUICK ACTIONS */
        .quick-actions { 
            display: flex; 
            gap: 10px; 
            margin-top: 20px; 
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn-full {
            width: 100%;
            padding: 12px;
            font-size: 13px;
        }

        /* MONTHLY STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #f1f2f6;
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            border-color: var(--blue);
            transform: translateY(-3px);
        }
        
        .stat-value {
            font-size: 22px;
            font-weight: 700;
            margin: 5px 0;
        }
        
        .stat-in { color: var(--green); }
        .stat-out { color: var(--red); }
        .stat-profit { color: var(--blue); }

        /* CALENDAR */
        .toggle-bar {
            text-align: center; 
            background: rgba(255,255,255,0.6); 
            padding: 12px; 
            color: var(--dark);
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 13px; 
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .toggle-bar:hover {
            background: rgba(255,255,255,0.8);
            border-color: var(--blue);
        }
        
        #calendarSection { 
            display: none; 
            animation: fadeIn 0.5s ease;
        }
        
        .calendar-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        
        .cal-nav { 
            background: white; 
            border: none; 
            border-radius: 50%; 
            width: 36px; 
            height: 36px; 
            cursor: pointer; 
            font-weight: bold; 
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .cal-nav:hover {
            background: var(--blue);
            color: white;
            transform: scale(1.1);
        }

        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 6px; 
        }
        
        .day-header { 
            text-align: center; 
            font-size: 11px; 
            font-weight: 700; 
            color: #b2bec3; 
            margin-bottom: 5px; 
            padding: 5px;
        }

        .day-card {
            background: white; 
            border-radius: 10px; 
            min-height: 65px; 
            padding: 6px; 
            border: 1px solid #f1f2f6; 
            cursor: pointer; 
            position: relative;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            transition: all 0.2s;
        }
        
        .day-card:hover { 
            border-color: var(--blue); 
            transform: translateY(-2px); 
            z-index: 2; 
            box-shadow: 0 6px 15px rgba(0,0,0,0.08); 
        }
        
        .day-card.today { 
            background: #e3f2fd; 
            border-color: var(--blue); 
            border-width: 2px;
        }
        
        .day-card.has-data {
            background: #f9f9f9;
        }
        
        .day-number {
            font-size: 11px; 
            font-weight: 700; 
            color: #636e72; 
            margin-bottom: 3px;
        }
        
        .day-card.today .day-number {
            color: var(--blue);
            font-weight: 800;
        }
        
        .val-txt { 
            font-size: 9px; 
            font-weight: 700; 
            text-align: right; 
            display: block; 
            line-height: 1.2; 
            margin-top: 2px;
        }
        
        .c-green { 
            color: var(--green); 
        }
        
        .c-red { 
            color: var(--red); 
        }

        /* MODAL */
        .modal-overlay {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.6); 
            z-index: 1000; 
            justify-content: center; 
            align-items: center; 
            backdrop-filter: blur(3px);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content { 
            background: white; 
            width: 320px; 
            max-width: 90%; 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 15px 50px rgba(0,0,0,0.25);
            animation: slideUp 0.3s ease;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* CHART */
        .chart-container {
            height: 200px;
            margin-top: 15px;
            position: relative;
        }

        /* STATUS INDICATOR */
        #statusIndicator {
            position: fixed; 
            bottom: 15px; 
            right: 15px; 
            font-size: 11px; 
            background: var(--dark); 
            color: white; 
            padding: 8px 15px; 
            border-radius: 20px; 
            opacity: 0; 
            transition: opacity 0.5s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 100;
        }

        /* BACKUP STATUS */
        .backup-status {
            position: fixed;
            bottom: 15px;
            left: 15px;
            font-size: 10px;
            color: var(--text-sub);
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 10px;
            border: 1px solid #dfe6e9;
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid #dfe6e9;
            padding-bottom: 5px;
        }
        
        .tab-btn {
            padding: 8px 15px;
            background: none;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-sub);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: var(--blue);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        /* ANIMATIONS */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .assets-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .quick-actions .btn {
                width: 100%;
            }
            
            .calendar-grid {
                gap: 4px;
            }
            
            .day-card {
                min-height: 55px;
                padding: 4px;
            }
            
            .app-title {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .glass-card {
                padding: 15px;
            }
            
            .balance-total {
                font-size: 24px;
            }
            
            .alpha-total {
                font-size: 18px;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
            }
            
            .day-card {
                min-height: 50px;
            }
        }

        /* LOADING */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* UTILITY CLASSES */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mb-10 { margin-bottom: 10px; }
        .mt-10 { margin-top: 10px; }
        .mb-15 { margin-bottom: 15px; }
        .mt-15 { margin-top: 15px; }
        .mb-20 { margin-bottom: 20px; }
        .mt-20 { margin-top: 20px; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-5 { gap: 5px; }
        .gap-10 { gap: 10px; }
        .gap-15 { gap: 15px; }
        .w-full { width: 100%; }

    </style>
</head>
<body>

<div class="app-container">
    
    <!-- HEADER -->
    <div class="app-header">
        <h1 class="app-title">üí∞ Qu·∫£n L√Ω T√†i Ch√≠nh Ultimate Pro</h1>
        <div class="app-subtitle">Qu·∫£n l√Ω t√†i ch√≠nh c√° nh√¢n th√¥ng minh & tr·ª±c quan</div>
        <div id="lastSync" class="last-sync">Ch∆∞a ƒë·ªìng b·ªô</div>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('dashboard')">üìä T·ªïng quan</button>
        <button class="tab-btn" onclick="switchTab('calendar')">üìÖ L·ªãch s·ª≠</button>
        <button class="tab-btn" onclick="switchTab('analytics')">üìà Th·ªëng k√™</button>
        <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è C√†i ƒë·∫∑t</button>
    </div>

    <!-- DASHBOARD TAB -->
    <div id="dashboardTab" class="tab-content active">
        
        <!-- T·ªîNG QUAN T√ÄI CH√çNH -->
        <div class="glass-card">
            <div class="dashboard-header">
                <div class="balance-group">
                    <div class="balance-label">T·ªîNG S·ªê D∆Ø HI·ªÜN T·∫†I</div>
                    <div class="balance-total" id="totalBalanceVND">0 ‚Ç´</div>
                    <small style="color: var(--text-sub);">T·ªïng s·ªë d∆∞ t·ª´ t·∫•t c·∫£ t√†i kho·∫£n</small>
                </div>

                <div class="alpha-box">
                    <div class="balance-label" style="color: var(--purple)">üìà T√ÄI S·∫¢N ALPHA</div>
                    <div class="alpha-total" id="alphaTotalVND">0 ‚Ç´</div>
                    <div id="profitBadge" class="profit-badge">L√£i th√°ng: ƒêang t√≠nh...</div>
                </div>
            </div>

            <!-- C√ÅC KHO·∫¢N T√ÄI S·∫¢N -->
            <div class="assets-grid">
                <!-- BANK -->
                <div class="input-group">
                    <label class="input-label">üè¶ S·ªë d∆∞ Ng√¢n h√†ng (VND)</label>
                    <div class="input-with-button">
                        <button class="btn btn-red btn-small" onclick="changeBank(-1)" title="Tr·ª´ t·ª´ t√†i kho·∫£n">-</button>
                        <input type="number" id="bankBalance" class="modern-input inp-vnd" placeholder="Nh·∫≠p s·ªë d∆∞..." onchange="saveConfig()">
                        <button class="btn btn-green btn-small" onclick="changeBank(1)" title="C·ªông v√†o t√†i kho·∫£n">+</button>
                    </div>
                </div>

                <!-- T·ª∂ GI√Å -->
                <div class="input-group">
                    <label class="input-label">üí± T·ª∑ gi√° USD/VND</label>
                    <input type="number" id="exchangeRate" class="modern-input" value="27000" onchange="saveConfig()" min="1" step="100">
                </div>

                <!-- USD MI 11 -->
                <div class="input-group">
                    <label class="input-label">üì± USD Mi 11</label>
                    <div class="input-with-button">
                        <input type="number" id="usdMi11" class="modern-input inp-usd" placeholder="$..." onchange="saveConfig()">
                        <button class="btn btn-orange btn-small" onclick="addUSD('usdMi11')" title="Th√™m USD">+</button>
                    </div>
                </div>

                <!-- USD K60 -->
                <div class="input-group">
                    <label class="input-label">üíª USD K60</label>
                    <div class="input-with-button">
                        <input type="number" id="usdK60" class="modern-input inp-usd" placeholder="$..." onchange="saveConfig()">
                        <button class="btn btn-orange btn-small" onclick="addUSD('usdK60')" title="Th√™m USD">+</button>
                    </div>
                </div>

                <!-- USD N7 -->
                <div class="input-group">
                    <label class="input-label">üì± USD N7</label>
                    <div class="input-with-button">
                        <input type="number" id="usdN7" class="modern-input inp-usd" placeholder="$..." onchange="saveConfig()">
                        <button class="btn btn-orange btn-small" onclick="addUSD('usdN7')" title="Th√™m USD">+</button>
                    </div>
                </div>

                <!-- V·ªêN ALPHA -->
                <div class="input-group">
                    <label class="input-label" style="color: var(--purple)">‚öõÔ∏è V·ªën Alpha ($)</label>
                    <input type="number" id="usdAlpha" class="modern-input inp-alpha" value="10206" onchange="saveConfig()" min="0">
                </div>
            </div>
        </div>

        <!-- GIAO D·ªäCH NHANH -->
        <div class="glass-card">
            <div class="input-label" style="margin-bottom:10px;">‚ö° GIAO D·ªäCH NHANH H√îM NAY (ALPHA $)</div>
            <div class="flex gap-10 mb-15">
                <input type="number" id="quickIn" class="modern-input" placeholder="+ Thu ($)" style="border-color: #00b894;">
                <input type="number" id="quickOut" class="modern-input" placeholder="- Chi ($)" style="border-color: #d63031;">
            </div>
            
            <div class="quick-actions">
                <button class="btn btn-blue" onclick="saveQuick()">
                    üíæ L∆∞u Giao D·ªãch
                </button>
                <button class="btn btn-orange" onclick="spend10()">
                    ‚ö° Chi 10$
                </button>
                <button id="btnUndo" class="btn btn-gray" onclick="execUndo()" title="Ho√†n t√°c thao t√°c g·∫ßn nh·∫•t">
                    ‚Ü© Undo
                </button>
            </div>
        </div>

        <!-- TH·ªêNG K√ä TH√ÅNG -->
        <div class="glass-card">
            <div class="input-label mb-10">üìä TH·ªêNG K√ä TH√ÅNG <span id="currentMonthText">HI·ªÜN T·∫†I</span> (ALPHA $)</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="balance-label">T·ªîNG THU</div>
                    <div class="stat-value stat-in" id="monthIn">0 $</div>
                    <small style="color: var(--text-sub);">Thu nh·∫≠p trong th√°ng</small>
                </div>
                <div class="stat-card">
                    <div class="balance-label">T·ªîNG CHI</div>
                    <div class="stat-value stat-out" id="monthOut">0 $</div>
                    <small style="color: var(--text-sub);">Chi ti√™u trong th√°ng</small>
                </div>
                <div class="stat-card">
                    <div class="balance-label">L√ÉI / L·ªñ</div>
                    <div class="stat-value stat-profit" id="monthProfit">0 $</div>
                    <small style="color: var(--text-sub);">L·ª£i nhu·∫≠n r√≤ng</small>
                </div>
            </div>
        </div>

        <!-- XU·∫§T EXCEL -->
        <button class="btn btn-green btn-full" onclick="exportToExcel()">
            üìä Xu·∫•t B√°o C√°o Excel
        </button>

    </div>

    <!-- CALENDAR TAB -->
    <div id="calendarTab" class="tab-content">
        <div class="glass-card">
            <div class="calendar-header">
                <button class="cal-nav" onclick="changeMonth(-1)">‚ùÆ</button>
                <span style="font-weight:700; font-size:16px;" id="monthDisplay">12/2025</span>
                <button class="cal-nav" onclick="changeMonth(1)">‚ùØ</button>
            </div>
            
            <div class="flex justify-between items-center mb-15">
                <small onclick="restoreData()" style="color:#0984e3; cursor:pointer; font-size:12px; text-decoration: underline;">
                    üîÑ Kh√¥i ph·ª•c d·ªØ li·ªáu m·∫´u
                </small>
                <small onclick="clearMonthData()" style="color:#d63031; cursor:pointer; font-size:12px;">
                    üóëÔ∏è X√≥a d·ªØ li·ªáu th√°ng n√†y
                </small>
            </div>

            <div class="calendar-grid" id="calendar"></div>
        </div>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="analyticsTab" class="tab-content">
        <div class="glass-card">
            <div class="input-label mb-15">üìà BI·ªÇU ƒê·ªí THU CHI THEO TH√ÅNG</div>
            <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>

        <div class="glass-card">
            <div class="input-label mb-15">üìã T·ªîNG H·ª¢P NƒÇM <span id="currentYear">2025</span></div>
            <div id="yearSummary" style="font-size: 13px;">
                ƒêang t·∫£i d·ªØ li·ªáu...
            </div>
        </div>
    </div>

    <!-- SETTINGS TAB -->
    <div id="settingsTab" class="tab-content">
        <div class="glass-card">
            <div class="input-label mb-15">‚öôÔ∏è C√ÄI ƒê·∫∂T H·ªÜ TH·ªêNG</div>
            
            <div class="flex flex-col gap-15">
                <div>
                    <label class="input-label">üîÑ Sao l∆∞u t·ª± ƒë·ªông</label>
                    <select id="autoBackup" class="modern-input" onchange="updateBackupSetting()">
                        <option value="5">5 ph√∫t</option>
                        <option value="10" selected>10 ph√∫t</option>
                        <option value="30">30 ph√∫t</option>
                        <option value="60">1 gi·ªù</option>
                        <option value="0">T·∫Øt</option>
                    </select>
                </div>

                <div>
                    <label class="input-label">üíæ Qu·∫£n l√Ω d·ªØ li·ªáu</label>
                    <div class="flex gap-10 mt-10">
                        <button class="btn btn-blue" onclick="backupData()">
                            üíæ Sao l∆∞u ngay
                        </button>
                        <button class="btn btn-purple" onclick="importData()">
                            üìÅ Nh·∫≠p d·ªØ li·ªáu
                        </button>
                        <button class="btn btn-red" onclick="clearAllData()">
                            üóëÔ∏è X√≥a t·∫•t c·∫£
                        </button>
                    </div>
                </div>

                <div>
                    <label class="input-label">üåê ƒê·ªìng b·ªô Firebase</label>
                    <div class="flex items-center gap-10 mt-10">
                        <span id="firebaseStatus" style="font-size:12px; color: var(--green);">
                            ‚úÖ ƒê√£ k·∫øt n·ªëi
                        </span>
                        <button class="btn btn-small btn-gray" onclick="toggleFirebase()">
                            üîÑ Toggle
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- MODAL EDIT -->
<div class="modal-overlay" id="inputModal">
    <div class="modal-content">
        <h4 id="modalTitle" style="margin-top:0; text-align:center;">‚úèÔ∏è S·ª≠a giao d·ªãch ng√†y <span id="modalDate"></span></h4>
        
        <div class="mb-15">
            <label class="input-label">üì• Thu nh·∫≠p ($)</label>
            <input type="number" id="modalIn" class="modern-input" placeholder="S·ªë ti·ªÅn thu..." step="0.01">
        </div>
        
        <div class="mb-20">
            <label class="input-label">üì§ Chi ti√™u ($)</label>
            <input type="number" id="modalOut" class="modern-input" placeholder="S·ªë ti·ªÅn chi..." step="0.01">
        </div>
        
        <div class="modal-actions">
            <button class="btn btn-blue" onclick="saveModal()">
                üíæ L∆∞u thay ƒë·ªïi
            </button>
            <button class="btn btn-gray" onclick="closeModal()">
                ‚úñÔ∏è ƒê√≥ng
            </button>
        </div>
    </div>
</div>

<!-- STATUS INDICATOR -->
<div id="statusIndicator">ƒêang ƒë·ªìng b·ªô...</div>

<!-- BACKUP STATUS -->
<div id="backupStatus" class="backup-status">‚è≥ Ch∆∞a sao l∆∞u</div>

<!-- HIDDEN FILE INPUT -->
<input type="file" id="fileImport" style="display: none;" accept=".json,.xlsx">

<script type="module">
    // ========== C·∫§U H√åNH V√Ä BI·∫æN TO√ÄN C·ª§C ==========
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBk5BR4mtmv1Mcj4gYrbCKLwNiC5fhKlj4",
        authDomain: "thu-nhap-6be80.firebaseapp.com",
        databaseURL: "https://thu-nhap-6be80-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "thu-nhap-6be80",
        storageBucket: "thu-nhap-6be80.firebasestorage.app",
        messagingSenderId: "482191171526",
        appId: "1:482191171526:web:358e486e9d28f194469cc7",
        measurementId: "G-0B436SXQ0P"
    };

    // State Management
    window.dataStore = {};
    window.configStore = {
        bank: 0,
        mi11: 0,
        k60: 0,
        n7: 0,
        alpha: 10206,
        rate: 27000,
        settings: {
            autoBackup: 10,
            firebaseEnabled: true
        }
    };
    
    window.undoStack = [];
    window.currentDate = new Date();
    window.firebaseEnabled = true;
    window.chart = null;
    window.lastBackup = null;

    // Sample Data
    const SAMPLE_DATA = {
        "2025-12-1": { in: 5, out: 10 }, "2025-12-2": { in: 0, out: 10 }, "2025-12-3": { in: 0, out: 10 },
        "2025-12-4": { in: 0, out: 10 }, "2025-12-5": { in: 0, out: 10 }, "2025-12-6": { in: 0, out: 10 },
        "2025-12-7": { in: 0, out: 10 }, "2025-12-8": { in: 150, out: 10 }, "2025-12-9": { in: 50, out: 10 },
        "2025-12-10": { in: 0, out: 10 }, "2025-12-11": { in: 123, out: 13 }, "2025-12-12": { in: 0, out: 10 },
        "2025-12-13": { in: 96.8, out: 10 }, "2025-12-14": { in: 0, out: 10 }, "2025-12-15": { in: 0, out: 10.6 },
        "2025-12-16": { in: 0, out: 10 }, "2025-12-17": { in: 10, out: 10 }, "2025-12-18": { in: 86, out: 10 },
        "2025-12-19": { in: 90.91, out: 10 }, "2025-12-20": { in: 0, out: 10 }, "2025-12-21": { in: 0, out: 10 },
        "2025-12-22": { in: 0, out: 10 }, "2025-12-23": { in: 0, out: 17 }, "2025-12-24": { in: 42, out: 10 },
        "2025-12-25": { in: 0, out: 10 }, "2025-12-26": { in: 0, out: 10 }, "2025-12-27": { in: 0, out: 10 },
        "2025-12-28": { in: 0, out: 10 }, "2025-12-29": { in: 0, out: 10 }, "2025-12-30": { in: 0, out: 10 },
        "2025-12-31": { in: 0, out: 10 }
    };

    // ========== KH·ªûI T·∫†O FIREBASE ==========
    let app, db;
    
    function initFirebase() {
        try {
            if (window.firebaseEnabled) {
                app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                console.log("‚úÖ Firebase ƒë√£ k·∫øt n·ªëi");
                document.getElementById('firebaseStatus').innerText = '‚úÖ ƒê√£ k·∫øt n·ªëi';
                document.getElementById('firebaseStatus').style.color = 'var(--green)';
                loadFirebaseData();
            } else {
                console.log("‚ÑπÔ∏è Firebase ƒë√£ t·∫Øt");
                document.getElementById('firebaseStatus').innerText = '‚ùå ƒê√£ t·∫Øt';
                document.getElementById('firebaseStatus').style.color = 'var(--red)';
                loadLocalData();
            }
        } catch (e) {
            console.error("‚ùå L·ªói Firebase:", e);
            document.getElementById('firebaseStatus').innerText = '‚ùå L·ªói k·∫øt n·ªëi';
            document.getElementById('firebaseStatus').style.color = 'var(--red)';
            loadLocalData();
        }
    }

    function loadFirebaseData() {
        if (!db) return;
        
        showStatus("üîÑ ƒêang t·∫£i d·ªØ li·ªáu...");
        
        // Load Configuration
        onValue(ref(db, 'config'), (snap) => {
            const val = snap.val();
            if (val) {
                window.configStore = { ...window.configStore, ...val };
                updateConfigUI();
                updateCalculations();
            }
        }, { onlyOnce: true });
        
        // Load Transaction Data
        onValue(ref(db, 'data'), (snap) => {
            const val = snap.val();
            if (val) {
                window.dataStore = val;
            } else {
                window.dataStore = { ...SAMPLE_DATA };
                syncToCloud();
            }
            updateCalculations();
            renderCal();
            updateChart();
            updateYearSummary();
            showStatus("‚úÖ ƒê√£ t·∫£i xong", 2000);
            updateLastSync();
        }, { onlyOnce: true });
    }

    function loadLocalData() {
        // Load t·ª´ localStorage
        const savedData = localStorage.getItem('finance_data');
        const savedConfig = localStorage.getItem('finance_config');
        
        if (savedData) {
            window.dataStore = JSON.parse(savedData);
        } else {
            window.dataStore = { ...SAMPLE_DATA };
        }
        
        if (savedConfig) {
            window.configStore = { ...window.configStore, ...JSON.parse(savedConfig) };
        }
        
        updateConfigUI();
        updateCalculations();
        renderCal();
        updateChart();
        updateYearSummary();
        showStatus("‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu c·ª•c b·ªô", 2000);
    }

    // ========== TI·ªÜN √çCH V√Ä H√ÄM H·ªñ TR·ª¢ ==========
    function showStatus(message, duration = 3000) {
        const indicator = document.getElementById('statusIndicator');
        indicator.innerText = message;
        indicator.style.opacity = 1;
        
        if (duration > 0) {
            setTimeout(() => {
                indicator.style.opacity = 0;
            }, duration);
        }
    }

    function updateLastSync() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('lastSync').innerText = `C·∫≠p nh·∫≠t l√∫c: ${timeStr}`;
    }

    function validateNumber(value, fieldName = 'gi√° tr·ªã') {
        const num = parseFloat(value);
        if (isNaN(num) || num < 0) {
            throw new Error(`${fieldName} kh√¥ng h·ª£p l·ªá!`);
        }
        return num;
    }

    function formatCurrency(amount, currency = 'VND') {
        if (currency === 'VND') {
            return amount.toLocaleString('vi-VN') + ' ‚Ç´';
        } else {
            return amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' $';
        }
    }

    function getTodayKey() {
        const d = new Date();
        return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
    }

    // ========== QU·∫¢N L√ù D·ªÆ LI·ªÜU ==========
    function syncToCloud() {
        if (!db || !window.firebaseEnabled) {
            saveToLocal();
            return;
        }
        
        showStatus("üîÑ ƒêang ƒë·ªìng b·ªô l√™n cloud...");
        set(ref(db, 'data'), window.dataStore)
            .then(() => {
                showStatus("‚úÖ ƒê√£ ƒë·ªìng b·ªô", 2000);
                updateLastSync();
            })
            .catch(error => {
                console.error("L·ªói ƒë·ªìng b·ªô:", error);
                showStatus("‚ùå L·ªói ƒë·ªìng b·ªô", 3000);
                saveToLocal(); // Fallback to localStorage
            });
    }

    function syncConfig() {
        if (!db || !window.firebaseEnabled) {
            saveToLocal();
            return;
        }
        
        set(ref(db, 'config'), window.configStore)
            .catch(error => {
                console.error("L·ªói ƒë·ªìng b·ªô config:", error);
                saveToLocal();
            });
    }

    function saveToLocal() {
        localStorage.setItem('finance_data', JSON.stringify(window.dataStore));
        localStorage.setItem('finance_config', JSON.stringify(window.configStore));
        window.lastBackup = new Date();
        updateBackupStatus();
    }

    // ========== C·∫¨P NH·∫¨T GIAO DI·ªÜN ==========
    function updateConfigUI() {
        const config = window.configStore;
        document.getElementById('bankBalance').value = config.bank || '';
        document.getElementById('usdMi11').value = config.mi11 || '';
        document.getElementById('usdK60').value = config.k60 || '';
        document.getElementById('usdN7').value = config.n7 || '';
        document.getElementById('usdAlpha').value = config.alpha || 10206;
        document.getElementById('exchangeRate').value = config.rate || 27000;
        
        if (config.settings) {
            document.getElementById('autoBackup').value = config.settings.autoBackup || 10;
        }
    }

    window.saveConfig = function() {
        window.configStore = {
            bank: parseFloat(document.getElementById('bankBalance').value) || 0,
            mi11: parseFloat(document.getElementById('usdMi11').value) || 0,
            k60: parseFloat(document.getElementById('usdK60').value) || 0,
            n7: parseFloat(document.getElementById('usdN7').value) || 0,
            alpha: parseFloat(document.getElementById('usdAlpha').value) || 10206,
            rate: parseFloat(document.getElementById('exchangeRate').value) || 27000,
            settings: window.configStore.settings || { autoBackup: 10, firebaseEnabled: true }
        };
        
        syncConfig();
        updateCalculations();
        showStatus("üíæ ƒê√£ l∆∞u c·∫•u h√¨nh", 1500);
    }

    // ========== T√çNH TO√ÅN T√ÄI CH√çNH ==========
    function calcMonthlyProfitUSD(year = null, month = null) {
        const y = year || window.currentDate.getFullYear();
        const m = month || window.currentDate.getMonth() + 1;
        
        let tIn = 0, tOut = 0;
        for (let k in window.dataStore) {
            const [yy, mm] = k.split('-').map(Number);
            if (yy === y && mm === m) {
                tIn += parseFloat(window.dataStore[k].in) || 0;
                tOut += parseFloat(window.dataStore[k].out) || 0;
            }
        }
        return { income: tIn, expense: tOut, profit: tIn - tOut };
    }

    function updateCalculations() {
        // L·∫•y d·ªØ li·ªáu th√°ng hi·ªán t·∫°i
        const monthly = calcMonthlyProfitUSD();
        
        // L·∫•y c·∫•u h√¨nh
        const { bank, mi11, k60, n7, alpha, rate } = window.configStore;
        
        // T√≠nh t·ªïng t√†i s·∫£n
        const sumUsdAssets = mi11 + k60 + n7;
        const totalBalanceVND = bank + (sumUsdAssets * rate);
        
        // T√≠nh t√†i s·∫£n Alpha
        const alphaTotalVND = (alpha + monthly.profit) * rate;
        const profitVND = monthly.profit * rate;
        
        // C·∫≠p nh·∫≠t giao di·ªán
        document.getElementById('totalBalanceVND').innerText = formatCurrency(totalBalanceVND, 'VND');
        document.getElementById('alphaTotalVND').innerText = formatCurrency(alphaTotalVND, 'VND');
        
        // C·∫≠p nh·∫≠t badge l·ª£i nhu·∫≠n
        const pBadge = document.getElementById('profitBadge');
        const m = window.currentDate.getMonth() + 1;
        const y = window.currentDate.getFullYear();
        
        pBadge.innerText = `L√£i th√°ng ${m}/${y}: ${(monthly.profit >= 0 ? '+' : '') + monthly.profit.toFixed(2)} $ (‚âà ${formatCurrency(profitVND, 'VND')})`;
        pBadge.className = monthly.profit < 0 ? 'profit-badge neg' : 'profit-badge';
        
        // C·∫≠p nh·∫≠t th·ªëng k√™ th√°ng
        updateMonthlyStats();
    }

    function updateMonthlyStats() {
        const monthly = calcMonthlyProfitUSD();
        
        document.getElementById('monthIn').innerText = formatCurrency(monthly.income, 'USD');
        document.getElementById('monthOut').innerText = formatCurrency(monthly.expense, 'USD');
        document.getElementById('monthProfit').innerText = 
            (monthly.profit >= 0 ? '+' : '') + formatCurrency(monthly.profit, 'USD');
        
        // C·∫≠p nh·∫≠t text th√°ng hi·ªán t·∫°i
        const monthNames = ['Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6',
                          'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'];
        const currentMonth = window.currentDate.getMonth();
        document.getElementById('currentMonthText').innerText = monthNames[currentMonth];
    }

    // ========== UNDO SYSTEM ==========
    function pushUndo() {
        window.undoStack.push({
            data: JSON.parse(JSON.stringify(window.dataStore)),
            config: JSON.parse(JSON.stringify(window.configStore)),
            timestamp: new Date()
        });
        
        if (window.undoStack.length > 20) {
            window.undoStack.shift();
        }
        
        renderUndoBtn();
    }

    window.execUndo = function() {
        if (window.undoStack.length > 0) {
            const prev = window.undoStack.pop();
            window.dataStore = prev.data;
            window.configStore = prev.config;
            
            updateConfigUI();
            syncToCloud();
            syncConfig();
            updateCalculations();
            renderCal();
            renderUndoBtn();
            
            showStatus("‚Ü© ƒê√£ ho√†n t√°c", 2000);
        }
    }

    function renderUndoBtn() {
        const btn = document.getElementById('btnUndo');
        if (window.undoStack.length > 0) {
            btn.classList.add('active');
            btn.innerText = `‚Ü© Undo (${window.undoStack.length})`;
            btn.title = `Ho√†n t√°c (${window.undoStack.length}) b∆∞·ªõc g·∫ßn nh·∫•t`;
        } else {
            btn.classList.remove('active');
            btn.innerText = `‚Ü© Undo`;
            btn.title = 'Kh√¥ng c√≥ thao t√°c ƒë·ªÉ ho√†n t√°c';
        }
    }

    // ========== QUICK ACTIONS ==========
    window.spend10 = function() {
        pushUndo();
        const k = getTodayKey();
        const cur = window.dataStore[k] || { in: 0, out: 0 };
        window.dataStore[k] = { in: cur.in, out: parseFloat(cur.out) + 10 };
        syncToCloud();
        updateCalculations();
        renderCal();
        showStatus("‚ö° ƒê√£ th√™m chi ph√≠ 10$", 1500);
    }

    window.saveQuick = function() {
        const inc = parseFloat(document.getElementById('quickIn').value) || 0;
        const exp = parseFloat(document.getElementById('quickOut').value) || 0;
        
        if (inc === 0 && exp === 0) {
            showStatus("‚ÑπÔ∏è Nh·∫≠p s·ªë li·ªáu tr∆∞·ªõc khi l∆∞u", 2000);
            return;
        }
        
        pushUndo();
        const k = getTodayKey();
        const cur = window.dataStore[k] || { in: 0, out: 0 };
        
        window.dataStore[k] = {
            in: parseFloat(cur.in) + inc,
            out: parseFloat(cur.out) + exp
        };
        
        document.getElementById('quickIn').value = '';
        document.getElementById('quickOut').value = '';
        
        syncToCloud();
        updateCalculations();
        renderCal();
        showStatus("üíæ ƒê√£ l∆∞u giao d·ªãch", 1500);
    }

    window.addUSD = function(inputId) {
        const val = prompt("Nh·∫≠p s·ªë USD mu·ªën c·ªông th√™m:", "0");
        if (val === null) return;
        
        try {
            const add = validateNumber(val, "S·ªë USD");
            pushUndo();
            
            const inp = document.getElementById(inputId);
            inp.value = (parseFloat(inp.value) || 0) + add;
            
            saveConfig();
            showStatus(`‚úÖ ƒê√£ th√™m ${add}$`, 1500);
        } catch (error) {
            alert(error.message);
        }
    }

    window.changeBank = function(dir) {
        const action = dir > 0 ? "C·ªòNG" : "TR·ª™";
        const val = prompt(`Nh·∫≠p s·ªë VND mu·ªën ${action}:`, "0");
        if (val === null) return;
        
        try {
            const amt = validateNumber(val, "S·ªë ti·ªÅn");
            pushUndo();
            
            const inp = document.getElementById('bankBalance');
            const cur = parseFloat(inp.value) || 0;
            inp.value = dir > 0 ? cur + amt : cur - amt;
            
            saveConfig();
            showStatus(`‚úÖ ƒê√£ ${dir > 0 ? 'c·ªông' : 'tr·ª´'} ${formatCurrency(amt, 'VND')}`, 1500);
        } catch (error) {
            alert(error.message);
        }
    }

    // ========== CALENDAR FUNCTIONS ==========
    window.changeMonth = function(s) {
        window.currentDate.setMonth(window.currentDate.getMonth() + s);
        renderCal();
        updateCalculations();
        updateChart();
    }

    window.renderCal = function() {
        const y = window.currentDate.getFullYear();
        const m = window.currentDate.getMonth();
        
        document.getElementById('monthDisplay').innerText = `${m + 1}/${y}`;
        
        const cal = document.getElementById('calendar');
        cal.innerHTML = '';
        
        // Day headers
        ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'].forEach(d => {
            cal.innerHTML += `<div class="day-header">${d}</div>`;
        });
        
        // Empty cells for days before 1st
        const firstDay = new Date(y, m, 1).getDay();
        for (let i = 0; i < firstDay; i++) {
            cal.innerHTML += `<div></div>`;
        }
        
        // Days of the month
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        const today = new Date();
        
        for (let i = 1; i <= daysInMonth; i++) {
            const k = `${y}-${m + 1}-${i}`;
            const d = window.dataStore[k] || { in: 0, out: 0 };
            const isToday = today.getFullYear() === y && 
                           today.getMonth() === m && 
                           today.getDate() === i;
            const hasData = d.in > 0 || d.out > 0;
            
            let dayClass = 'day-card';
            if (isToday) dayClass += ' today';
            if (hasData) dayClass += ' has-data';
            
            let htmlVal = `<div class="day-number">${i}</div>`;
            
            if (d.in > 0) {
                htmlVal += `<span class="val-txt c-green">+${parseFloat(d.in).toFixed(1)}</span>`;
            }
            if (d.out > 0) {
                htmlVal += `<span class="val-txt c-red">-${parseFloat(d.out).toFixed(1)}</span>`;
            }
            
            cal.innerHTML += `<div class="${dayClass}" onclick="openMod('${k}')">${htmlVal}</div>`;
        }
    }

    // ========== MODAL FUNCTIONS ==========
    let selKey = null;

    window.openMod = function(k) {
        selKey = k;
        const val = window.dataStore[k] || { in: '', out: '' };
        
        // Parse date for display
        const [y, m, d] = k.split('-').map(Number);
        const dateStr = `${d}/${m}/${y}`;
        
        document.getElementById('modalDate').innerText = dateStr;
        document.getElementById('modalIn').value = val.in || '';
        document.getElementById('modalOut').value = val.out || '';
        document.getElementById('inputModal').style.display = 'flex';
    }

    window.closeModal = function() {
        document.getElementById('inputModal').style.display = 'none';
    }

    window.saveModal = function() {
        pushUndo();
        
        const inc = parseFloat(document.getElementById('modalIn').value) || 0;
        const exp = parseFloat(document.getElementById('modalOut').value) || 0;
        
        if (inc === 0 && exp === 0) {
            delete window.dataStore[selKey];
        } else {
            window.dataStore[selKey] = { in: inc, out: exp };
        }
        
        syncToCloud();
        updateCalculations();
        renderCal();
        closeModal();
        showStatus("üíæ ƒê√£ c·∫≠p nh·∫≠t giao d·ªãch", 1500);
    }

    // ========== EXPORT/IMPORT FUNCTIONS ==========
    window.exportToExcel = function() {
        if (!window.dataStore || Object.keys(window.dataStore).length === 0) {
            showStatus("‚ùå Ch∆∞a c√≥ d·ªØ li·ªáu!", 3000);
            return;
        }
        
        const { bank, mi11, k60, n7, alpha, rate } = window.configStore;
        
        // Calculate totals
        let tIn = 0, tOut = 0;
        for (let k in window.dataStore) {
            tIn += parseFloat(window.dataStore[k].in) || 0;
            tOut += parseFloat(window.dataStore[k].out) || 0;
        }
        
        const profit = tIn - tOut;
        const alphaTotalVND = (alpha + profit) * rate;
        const mainTotalVND = bank + (mi11 + k60 + n7) * rate;
        
        // Prepare data
        const data = [
            ["B√ÅO C√ÅO T√ÄI CH√çNH CHI TI·∫æT - QU·∫¢N L√ù T√ÄI CH√çNH ULTIMATE PRO"],
            ["Ng√†y xu·∫•t b√°o c√°o:", new Date().toLocaleDateString('vi-VN') + ' ' + new Date().toLocaleTimeString('vi-VN')],
            ["Ng∆∞·ªùi d√πng:", "Qu·∫£n tr·ªã vi√™n"],
            [],
            ["=== T·ªîNG QUAN T√ÄI CH√çNH ==="],
            ["T·ªïng s·ªë d∆∞ hi·ªán t·∫°i:", mainTotalVND, "VND"],
            ["T·ªïng t√†i s·∫£n Alpha:", alphaTotalVND, "VND"],
            ["L·ª£i nhu·∫≠n th√°ng:", profit, "USD"],
            ["L·ª£i nhu·∫≠n quy ƒë·ªïi:", profit * rate, "VND"],
            [],
            ["=== CHI TI·∫æT T√ÄI S·∫¢N ==="],
            ["Lo·∫°i t√†i s·∫£n", "S·ªë l∆∞·ª£ng", "ƒê∆°n v·ªã", "Quy ƒë·ªïi (VND)"],
            ["S·ªë d∆∞ ng√¢n h√†ng", bank, "VND", bank],
            ["USD Mi 11", mi11, "USD", mi11 * rate],
            ["USD K60", k60, "USD", k60 * rate],
            ["USD N7", n7, "USD", n7 * rate],
            ["V·ªën Alpha", alpha, "USD", alpha * rate],
            [],
            ["=== TH·ªêNG K√ä GIAO D·ªäCH ==="],
            ["T·ªïng thu:", tIn, "USD"],
            ["T·ªïng chi:", tOut, "USD"],
            ["T·ª∑ gi√° √°p d·ª•ng:", rate, "VND/USD"],
            [],
            ["=== CHI TI·∫æT GIAO D·ªäCH THEO NG√ÄY ==="],
            ["Ng√†y", "Thu ($)", "Chi ($)", "L·ª£i nhu·∫≠n ($)", "Quy ƒë·ªïi (VND)", "Ghi ch√∫"]
        ];
        
        // Sort dates
        const keys = Object.keys(window.dataStore).sort((a, b) => new Date(a) - new Date(b));
        
        keys.forEach(key => {
            const item = window.dataStore[key];
            const prof = (parseFloat(item.in) || 0) - (parseFloat(item.out) || 0);
            const note = prof > 0 ? "L√£i" : prof < 0 ? "L·ªó" : "H√≤a v·ªën";
            data.push([key, item.in || 0, item.out || 0, prof, prof * rate, note]);
        });
        
        // Add summary row
        data.push([]);
        data.push(["T·ªîNG C·ªòNG", tIn, tOut, profit, profit * rate, profit > 0 ? "L√ÉI" : "L·ªñ"]);
        
        // Create worksheet
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // Auto-size columns
        const wscols = [
            { wch: 12 }, // Date
            { wch: 10 }, // Income
            { wch: 10 }, // Expense
            { wch: 12 }, // Profit
            { wch: 15 }, // Converted
            { wch: 10 }  // Note
        ];
        ws['!cols'] = wscols;
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "BaoCaoTaiChinh");
        
        // Generate filename with date
        const dateStr = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(wb, `BaoCaoTaiChinh_${dateStr}.xlsx`);
        
        showStatus("üìä ƒê√£ xu·∫•t file Excel th√†nh c√¥ng!", 3000);
    }

    function importData() {
        document.getElementById('fileImport').click();
    }

    document.getElementById('fileImport').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const data = JSON.parse(event.target.result);
                
                if (confirm("Nh·∫≠p d·ªØ li·ªáu n√†y s·∫Ω ghi ƒë√® d·ªØ li·ªáu hi·ªán t·∫°i. Ti·∫øp t·ª•c?")) {
                    pushUndo();
                    
                    if (data.dataStore) {
                        window.dataStore = data.dataStore;
                    }
                    if (data.configStore) {
                        window.configStore = data.configStore;
                        updateConfigUI();
                    }
                    
                    syncToCloud();
                    syncConfig();
                    updateCalculations();
                    renderCal();
                    updateChart();
                    
                    showStatus("‚úÖ ƒê√£ nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng", 3000);
                }
            } catch (error) {
                alert("L·ªói ƒë·ªçc file: " + error.message);
            }
        };
        reader.readAsText(file);
        
        // Reset input
        e.target.value = '';
    });

    function backupData() {
        const backup = {
            dataStore: window.dataStore,
            configStore: window.configStore,
            timestamp: new Date().toISOString(),
            version: '1.0'
        };
        
        const dataStr = JSON.stringify(backup, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `backup_finance_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        window.lastBackup = new Date();
        updateBackupStatus();
        showStatus("üíæ ƒê√£ sao l∆∞u d·ªØ li·ªáu", 2000);
    }

    // ========== CHART FUNCTIONS ==========
    function updateChart() {
        const ctx = document.getElementById('monthlyChart').getContext('2d');
        
        // Get data for last 6 months
        const months = [];
        const incomeData = [];
        const expenseData = [];
        const profitData = [];
        
        const currentDate = new Date();
        
        for (let i = 5; i >= 0; i--) {
            const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
            const monthData = calcMonthlyProfitUSD(date.getFullYear(), date.getMonth() + 1);
            
            months.push(`${date.getMonth() + 1}/${date.getFullYear()}`);
            incomeData.push(monthData.income);
            expenseData.push(monthData.expense);
            profitData.push(monthData.profit);
        }
        
        // Destroy existing chart
        if (window.chart) {
            window.chart.destroy();
        }
        
        // Create new chart
        window.chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    {
                        label: 'Thu ($)',
                        data: incomeData,
                        backgroundColor: 'rgba(0, 184, 148, 0.7)',
                        borderColor: 'rgba(0, 184, 148, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Chi ($)',
                        data: expenseData,
                        backgroundColor: 'rgba(214, 48, 49, 0.7)',
                        borderColor: 'rgba(214, 48, 49, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'L√£i ($)',
                        data: profitData,
                        type: 'line',
                        borderColor: 'rgba(9, 132, 227, 1)',
                        backgroundColor: 'rgba(9, 132, 227, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + ' $';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' $';
                            }
                        }
                    }
                }
            }
        });
    }

    function updateYearSummary() {
        const currentYear = window.currentDate.getFullYear();
        document.getElementById('currentYear').innerText = currentYear;
        
        let totalIncome = 0;
        let totalExpense = 0;
        let monthsWithData = 0;
        
        const monthlyData = [];
        
        for (let month = 1; month <= 12; month++) {
            const monthData = calcMonthlyProfitUSD(currentYear, month);
            if (monthData.income > 0 || monthData.expense > 0) {
                monthsWithData++;
            }
            
            totalIncome += monthData.income;
            totalExpense += monthData.expense;
            
            monthlyData.push({
                month: month,
                income: monthData.income,
                expense: monthData.expense,
                profit: monthData.profit
            });
        }
        
        const totalProfit = totalIncome - totalExpense;
        const avgMonthlyProfit = monthsWithData > 0 ? totalProfit / monthsWithData : 0;
        
        let summaryHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="balance-label">T·ªîNG THU NƒÇM</div>
                    <div class="stat-value stat-in">${formatCurrency(totalIncome, 'USD')}</div>
                </div>
                <div class="stat-card">
                    <div class="balance-label">T·ªîNG CHI NƒÇM</div>
                    <div class="stat-value stat-out">${formatCurrency(totalExpense, 'USD')}</div>
                </div>
                <div class="stat-card">
                    <div class="balance-label">L√ÉI C·∫¢ NƒÇM</div>
                    <div class="stat-value stat-profit">${formatCurrency(totalProfit, 'USD')}</div>
                </div>
            </div>
            <div style="font-size: 12px; color: var(--text-sub);">
                <p>üìÖ <strong>${monthsWithData}</strong> th√°ng c√≥ d·ªØ li·ªáu</p>
                <p>üìä L√£i trung b√¨nh/th√°ng: <strong>${formatCurrency(avgMonthlyProfit, 'USD')}</strong></p>
            </div>
        `;
        
        document.getElementById('yearSummary').innerHTML = summaryHTML;
    }

    // ========== SETTINGS FUNCTIONS ==========
    // S·ª¨A L·ªñI ·ªû ƒê√ÇY: Th√™m h√†m switchTab v√†o window object
    window.switchTab = function(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Deactivate all tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        const tabElement = document.getElementById(tabName + 'Tab');
        if (tabElement) {
            tabElement.classList.add('active');
        }
        
        // Activate selected button
        event.target.classList.add('active');
        
        // Update chart if switching to analytics
        if (tabName === 'analytics') {
            setTimeout(() => {
                if (window.updateChart) updateChart();
                if (window.updateYearSummary) updateYearSummary();
            }, 100);
        }
    }

    function updateBackupSetting() {
        const interval = parseInt(document.getElementById('autoBackup').value);
        window.configStore.settings.autoBackup = interval;
        syncConfig();
        
        // Clear existing interval
        if (window.backupInterval) {
            clearInterval(window.backupInterval);
        }
        
        // Set new interval if not 0
        if (interval > 0) {
            window.backupInterval = setInterval(() => {
                saveToLocal();
                showStatus("üîÑ ƒê√£ sao l∆∞u t·ª± ƒë·ªông", 2000);
            }, interval * 60 * 1000);
        }
        
        showStatus(`üíæ ƒê√£ c√†i ƒë·∫∑t sao l∆∞u ${interval > 0 ? interval + ' ph√∫t' : 't·∫Øt'}`, 2000);
    }

    function updateBackupStatus() {
        const statusEl = document.getElementById('backupStatus');
        if (window.lastBackup) {
            const diff = Math.floor((new Date() - window.lastBackup) / 1000 / 60); // minutes
            statusEl.innerText = `üíæ Sao l∆∞u: ${diff} ph√∫t tr∆∞·ªõc`;
            statusEl.style.color = diff < 60 ? 'var(--green)' : 'var(--orange)';
        } else {
            statusEl.innerText = '‚è≥ Ch∆∞a sao l∆∞u';
            statusEl.style.color = 'var(--red)';
        }
    }

    window.toggleFirebase = function() {
        window.firebaseEnabled = !window.firebaseEnabled;
        window.configStore.settings.firebaseEnabled = window.firebaseEnabled;
        
        if (window.firebaseEnabled) {
            initFirebase();
        } else {
            if (db) {
                // Firebase will continue to run but we won't sync
                showStatus("‚ÑπÔ∏è ƒê√£ t·∫Øt ƒë·ªìng b·ªô Firebase", 2000);
            }
            document.getElementById('firebaseStatus').innerText = '‚ùå ƒê√£ t·∫Øt';
            document.getElementById('firebaseStatus').style.color = 'var(--red)';
        }
        
        syncConfig();
    }

    window.clearMonthData = function() {
        const currentYear = window.currentDate.getFullYear();
        const currentMonth = window.currentDate.getMonth() + 1;
        
        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu c·ªßa th√°ng ${currentMonth}/${currentYear}?`)) {
            pushUndo();
            
            // Remove all entries for current month
            for (let key in window.dataStore) {
                const [year, month] = key.split('-').map(Number);
                if (year === currentYear && month === currentMonth) {
                    delete window.dataStore[key];
                }
            }
            
            syncToCloud();
            updateCalculations();
            renderCal();
            updateChart();
            showStatus(`üóëÔ∏è ƒê√£ x√≥a d·ªØ li·ªáu th√°ng ${currentMonth}/${currentYear}`, 3000);
        }
    }

    window.clearAllData = function() {
        if (confirm("‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n s·∫Øp x√≥a T·∫§T C·∫¢ d·ªØ li·ªáu. H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!\n\nNh·∫≠p 'DELETE' ƒë·ªÉ x√°c nh·∫≠n:")) {
            const confirmText = prompt("Nh·∫≠p 'DELETE' ƒë·ªÉ x√°c nh·∫≠n x√≥a t·∫•t c·∫£ d·ªØ li·ªáu:");
            if (confirmText === 'DELETE') {
                pushUndo();
                window.dataStore = {};
                window.configStore = {
                    bank: 0,
                    mi11: 0,
                    k60: 0,
                    n7: 0,
                    alpha: 10206,
                    rate: 27000,
                    settings: window.configStore.settings
                };
                
                updateConfigUI();
                syncToCloud();
                syncConfig();
                updateCalculations();
                renderCal();
                updateChart();
                
                showStatus("üóëÔ∏è ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu", 3000);
            }
        }
    }

    window.restoreData = function() {
        if (confirm("Kh√¥i ph·ª•c d·ªØ li·ªáu m·∫´u? D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã thay th·∫ø.")) {
            pushUndo();
            window.dataStore = { ...SAMPLE_DATA };
            syncToCloud();
            updateCalculations();
            renderCal();
            updateChart();
            showStatus("üîÑ ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu m·∫´u", 3000);
        }
    }

    // ========== INITIALIZATION ==========
    function init() {
        // Load settings from localStorage first
        const savedSettings = localStorage.getItem('finance_settings');
        if (savedSettings) {
            try {
                const settings = JSON.parse(savedSettings);
                window.firebaseEnabled = settings.firebaseEnabled !== false;
            } catch (e) {
                console.error("Error loading settings:", e);
            }
        }
        
        // Initialize Firebase
        initFirebase();
        
        // Setup auto-backup
        updateBackupSetting();
        
        // Initial render
        renderCal();
        updateCalculations();
        updateBackupStatus();
        
        // Auto-save on page unload
        window.addEventListener('beforeunload', () => {
            saveToLocal();
        });
        
        // Auto-save every minute if there are changes
        setInterval(() => {
            if (Object.keys(window.dataStore).length > 0) {
                saveToLocal();
            }
        }, 60000); // 1 minute
        
        console.log("‚úÖ ·ª®ng d·ª•ng ƒë√£ kh·ªüi ƒë·ªông th√†nh c√¥ng!");
    }

    // Start the application
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>