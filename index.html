<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω T√†i Ch√≠nh Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.95);
            --green: #00b894;
            --red: #d63031;
            --blue: #0984e3;
            --purple: #6c5ce7;
            --dark: #2d3436;
            --text-sub: #636e72;
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            margin: 0; padding: 15px;
            min-height: 100vh;
            color: var(--dark);
            display: flex; justify-content: center;
        }

        .app-container { width: 100%; max-width: 800px; }

        .glass-card {
            background: var(--glass);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 20px; margin-bottom: 20px;
            backdrop-filter: blur(5px);
        }

        /* HEADER & BALANCE */
        .dashboard-header { margin-bottom: 20px; border-bottom: 1px solid #dfe6e9; padding-bottom: 15px; }
        
        .balance-group { margin-bottom: 15px; }
        .balance-label { font-size: 11px; text-transform: uppercase; color: var(--text-sub); font-weight: 700; letter-spacing: 0.5px; }
        
        .balance-total { font-size: 28px; font-weight: 700; color: var(--dark); margin: 0; line-height: 1.2; }
        /* ƒê√£ x√≥a class balance-sub ·ªü ƒë√¢y */
        
        .alpha-box {
            background: rgba(108, 92, 231, 0.1); padding: 10px 15px; border-radius: 12px;
            margin-top: 10px; border: 1px solid rgba(108, 92, 231, 0.2);
        }
        .alpha-total { font-size: 20px; font-weight: 700; color: var(--purple); }

        .profit-badge {
            display: inline-block; padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 700;
            background: rgba(0, 184, 148, 0.15); color: var(--green); margin-top: 5px;
        }
        .profit-badge.neg { background: rgba(214, 48, 49, 0.15); color: var(--red); }

        /* INPUTS GRID */
        .assets-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        }
        .input-group { position: relative; }
        .input-label { font-size: 10px; font-weight: 700; color: var(--text-sub); margin-bottom: 3px; display: block; }
        
        .modern-input {
            width: 100%; padding: 8px 10px; border: 1px solid #dfe6e9; border-radius: 8px;
            font-size: 13px; font-weight: 600; outline: none; background: #fdfdfd; box-sizing: border-box;
            transition: 0.3s;
        }
        .modern-input:focus { border-color: var(--blue); background: white; }
        .inp-vnd { border-left: 3px solid var(--green); }
        .inp-usd { border-left: 3px solid #fdcb6e; }
        .inp-alpha { border-left: 3px solid var(--purple); }

        /* ACTIONS */
        .quick-actions { display: flex; gap: 8px; margin-top: 15px; align-items: center; }
        .btn {
            border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer;
            font-size: 12px; display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-blue { background: var(--blue); color: white; flex: 1; }
        .btn-flash { background: #fdcb6e; color: #d35400; width: 70px; }
        .btn-undo { background: #b2bec3; color: white; width: 70px; opacity: 0.5; pointer-events: none; }
        .btn-undo.active { opacity: 1; pointer-events: auto; background: #636e72; }
        .btn-excel { background: #27ae60; color: white; width: 100%; margin-top: 10px; padding: 12px; }

        /* CALENDAR */
        .toggle-bar {
            text-align: center; background: rgba(255,255,255,0.4); padding: 8px; color: var(--dark);
            border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 12px; margin-bottom: 15px;
        }
        #calendarSection { display: none; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-nav { background: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-header { text-align: center; font-size: 10px; font-weight: 700; color: #b2bec3; margin-bottom: 5px; }

        .day-card {
            background: white; border-radius: 8px; min-height: 55px; padding: 4px; 
            border: 1px solid #f1f2f6; cursor: pointer; position: relative;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .day-card:hover { border-color: var(--blue); transform: translateY(-2px); z-index: 2; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .day-card.today { background: #e3f2fd; border-color: var(--blue); }
        
        .val-txt { font-size: 9px; font-weight: 700; text-align: right; display: block; line-height: 1.1; }
        .c-green { color: var(--green); }
        .c-red { color: var(--red); }

        #statusIndicator {
            position: fixed; bottom: 10px; right: 10px; font-size: 10px; 
            background: var(--dark); color: white; padding: 5px 10px; border-radius: 20px; opacity: 0; transition: opacity 0.5s;
        }
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 999; justify-content: center; align-items: center; backdrop-filter: blur(2px);
        }
        .modal-content { background: white; width: 280px; padding: 20px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="app-container">

    <div class="glass-card">
        <div class="dashboard-header">
            <div class="balance-group">
                <div class="balance-label">T·ªîNG S·ªê D∆Ø (BANK + Mi11 + K60 + N7)</div>
                <div class="balance-total" id="totalBalanceVND">0 ‚Ç´</div>
                </div>

            <div class="alpha-box">
                <div class="balance-label" style="color: var(--purple)">T·ªîNG T·ª™ ALPHA (V·ªêN + L√ÉI)</div>
                <div class="alpha-total" id="alphaTotalVND">0 ‚Ç´</div>
                <div id="profitBadge" class="profit-badge">L√£i r√≤ng: 0</div>
            </div>
        </div>

        <div class="assets-grid">
            <div class="input-group">
                <label class="input-label">üè¶ S·ªë d∆∞ Bank (VND)</label>
                <input type="number" id="bankBalance" class="modern-input inp-vnd" placeholder="VND..." onchange="saveConfig()">
            </div>
            <div class="input-group">
                <label class="input-label">üí± T·ª∑ gi√° (VND)</label>
                <input type="number" id="exchangeRate" class="modern-input" value="27000" onchange="saveConfig()">
            </div>

            <div class="input-group">
                <label class="input-label">üì± USD Mi 11</label>
                <input type="number" id="usdMi11" class="modern-input inp-usd" placeholder="$..." onchange="saveConfig()">
            </div>
            <div class="input-group">
                <label class="input-label">üíª USD K60</label>
                <input type="number" id="usdK60" class="modern-input inp-usd" placeholder="$..." onchange="saveConfig()">
            </div>
            <div class="input-group" style="grid-column: span 2;">
                <label class="input-label">üì± USD N7</label>
                <input type="number" id="usdN7" class="modern-input inp-usd" placeholder="$..." onchange="saveConfig()">
            </div>

            <div class="input-group" style="grid-column: span 2;">
                <label class="input-label" style="color: var(--purple)">‚öõÔ∏è V·ªën Alpha ($)</label>
                <input type="number" id="usdAlpha" class="modern-input inp-alpha" value="10206" onchange="saveConfig()">
            </div>
        </div>
    </div>

    <div class="glass-card">
        <div class="input-label" style="margin-bottom:8px;">GIAO D·ªäCH H√îM NAY (ALPHA $)</div>
        <div style="display:flex; gap:10px;">
            <input type="number" id="quickIn" class="modern-input" placeholder="+ Thu ($)" style="border-color: #55efc4;">
            <input type="number" id="quickOut" class="modern-input" placeholder="- Chi ($)" style="border-color: #fab1a0;">
        </div>
        
        <div class="quick-actions">
            <button class="btn btn-blue" onclick="saveQuick()">L∆∞u Giao D·ªãch</button>
            <button class="btn btn-flash" onclick="spend10()">‚ö° 10$</button>
            <button id="btnUndo" class="btn btn-undo" onclick="execUndo()">‚Ü© Undo</button>
        </div>
        
        <button class="btn btn-excel" onclick="exportToExcel()">üìä Xu·∫•t File Excel</button>
    </div>

    <div class="toggle-bar" onclick="toggleCal()">üìÖ Ch·∫°m ƒë·ªÉ m·ªü L·ªãch S·ª≠</div>

    <div id="calendarSection">
        <div class="glass-card">
            <div class="calendar-header">
                <button class="cal-nav" onclick="changeMonth(-1)">‚ùÆ</button>
                <span style="font-weight:700; font-size:14px;" id="monthDisplay">12/2025</span>
                <button class="cal-nav" onclick="changeMonth(1)">‚ùØ</button>
            </div>
            
            <div style="text-align:right; margin-bottom:10px;">
                <small onclick="restoreData()" style="color:#0984e3; cursor:pointer; font-size:11px; text-decoration: underline;">üîÑ Kh√¥i ph·ª•c d·ªØ li·ªáu g·ªëc</small>
            </div>

            <div class="calendar-grid" id="calendar"></div>
        </div>
    </div>

</div>

<div id="statusIndicator">ƒêang ƒë·ªìng b·ªô...</div>

<div class="modal-overlay" id="inputModal">
    <div class="modal-content">
        <h4 id="modalTitle" style="margin-top:0; text-align:center;">S·ª≠a giao d·ªãch</h4>
        <input type="number" id="modalIn" class="modern-input" placeholder="Thu ($)" style="margin-bottom:10px;">
        <input type="number" id="modalOut" class="modern-input" placeholder="Chi ($)" style="margin-bottom:15px;">
        <button class="btn btn-blue" onclick="saveModal()">C·∫≠p nh·∫≠t</button>
        <button class="btn" style="width:100%; margin-top:10px; background:#dfe6e9;" onclick="closeModal()">ƒê√≥ng</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- FIREBASE CONFIG ---
    // ‚ö†Ô∏è H√ÉY D√ÅN CONFIG FIREBASE C·ª¶A B·∫†N V√ÄO ƒê√ÇY N·∫æU CH∆ØA C√ì ‚ö†Ô∏è
    const firebaseConfig = {
      apiKey: "AIzaSyBk5BR4mtmv1Mcj4gYrbCKLwNiC5fhKlj4",
      authDomain: "thu-nhap-6be80.firebaseapp.com",
      databaseURL: "https://thu-nhap-6be80-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "thu-nhap-6be80",
      storageBucket: "thu-nhap-6be80.firebasestorage.app",
      messagingSenderId: "482191171526",
      appId: "1:482191171526:web:358e486e9d28f194469cc7",
      measurementId: "G-0B436SXQ0P"
    };

    let app, db;
    try { app = initializeApp(firebaseConfig); db = getDatabase(app); } 
    catch(e) { console.error("Ch∆∞a config Firebase"); }

    // STATE
    window.dataStore = {}; 
    // Config: bank, c√°c ngu·ªìn USD, alpha, rate
    window.configStore = { bank: 0, mi11: 0, k60: 0, n7: 0, alpha: 10206, rate: 27000 };
    window.undoStack = [];
    window.currentDate = new Date(2025, 11, 1);
    
    // DATA M·∫™U T12
    const SAMPLE_DATA = {
        "2025-12-1": { in: 5, out: 10 }, "2025-12-2": { in: 0, out: 10 }, "2025-12-3": { in: 0, out: 10 },
        "2025-12-4": { in: 0, out: 10 }, "2025-12-5": { in: 0, out: 10 }, "2025-12-6": { in: 0, out: 10 },
        "2025-12-7": { in: 0, out: 10 }, "2025-12-8": { in: 150, out: 10 }, "2025-12-9": { in: 50, out: 10 },
        "2025-12-10": { in: 0, out: 10 }, "2025-12-11": { in: 123, out: 13 }, "2025-12-12": { in: 0, out: 10 },
        "2025-12-13": { in: 96.8, out: 10 }, "2025-12-14": { in: 0, out: 10 }, "2025-12-15": { in: 0, out: 10.6 },
        "2025-12-16": { in: 0, out: 10 }, "2025-12-17": { in: 10, out: 10 }, "2025-12-18": { in: 86, out: 10 },
        "2025-12-19": { in: 90.91, out: 10 }, "2025-12-20": { in: 0, out: 10 }, "2025-12-21": { in: 0, out: 10 },
        "2025-12-22": { in: 0, out: 10 }, "2025-12-23": { in: 0, out: 17 }, "2025-12-24": { in: 42, out: 10 },
        "2025-12-25": { in: 0, out: 10 }, "2025-12-26": { in: 0, out: 10 }, "2025-12-27": { in: 0, out: 10 },
        "2025-12-28": { in: 0, out: 10 }, "2025-12-29": { in: 0, out: 10 }, "2025-12-30": { in: 0, out: 10 },
        "2025-12-31": { in: 0, out: 10 }
    };

    // --- FIREBASE SYNC ---
    if(db) {
        showStatus(true);
        // Load Config
        onValue(ref(db, 'config'), (snap) => {
            const val = snap.val();
            if(val) {
                window.configStore = val;
                document.getElementById('bankBalance').value = val.bank || '';
                document.getElementById('usdMi11').value = val.mi11 || '';
                document.getElementById('usdK60').value = val.k60 || '';
                document.getElementById('usdN7').value = val.n7 || '';
                document.getElementById('usdAlpha').value = val.alpha || 10206;
                document.getElementById('exchangeRate').value = val.rate || 27000;
                updateCalculations();
            }
        });
        // Load Data
        onValue(ref(db, 'data'), (snap) => {
            const val = snap.val();
            if(val) window.dataStore = val;
            else { window.dataStore = {...SAMPLE_DATA}; syncToCloud(); }
            updateCalculations(); renderCal(); showStatus(false);
        });
    }

    function syncToCloud() { if(!db) return; showStatus(true); set(ref(db, 'data'), window.dataStore); }
    function syncConfig() { if(!db) return; set(ref(db, 'config'), window.configStore); }

    window.saveConfig = function() {
        window.configStore = {
            bank: parseFloat(document.getElementById('bankBalance').value) || 0,
            mi11: parseFloat(document.getElementById('usdMi11').value) || 0,
            k60: parseFloat(document.getElementById('usdK60').value) || 0,
            n7: parseFloat(document.getElementById('usdN7').value) || 0,
            alpha: parseFloat(document.getElementById('usdAlpha').value) || 10206,
            rate: parseFloat(document.getElementById('exchangeRate').value) || 27000
        };
        syncConfig(); updateCalculations();
    }

    // --- LOGIC T√çNH TO√ÅN (ƒê√É C·∫¨P NH·∫¨T) ---
    function updateCalculations() {
        // 1. T√≠nh L√£i R√≤ng t·ª´ L·ªãch (USD)
        let tIn = 0, tOut = 0;
        for (let k in window.dataStore) {
            tIn += parseFloat(window.dataStore[k].in) || 0;
            tOut += parseFloat(window.dataStore[k].out) || 0;
        }
        const profitUSD = tIn - tOut;
        
        const { bank, mi11, k60, n7, alpha, rate } = window.configStore;

        // 2. T√≠nh T·ªîNG S·ªê D∆Ø HI·ªÜN T·∫†I (Bank + Mi11 + K60 + N7) * Rate
        const sumUsdAssets = mi11 + k60 + n7;
        const totalBalanceVND = bank + (sumUsdAssets * rate);

        // 3. T√≠nh T·ªîNG ALPHA (V·ªën Alpha + L√£i) * Rate
        const alphaTotalVND = (alpha + profitUSD) * rate;

        // HI·ªÇN TH·ªä
        document.getElementById('totalBalanceVND').innerText = totalBalanceVND.toLocaleString('vi-VN') + ' ‚Ç´';
        // ƒê√£ x√≥a d√≤ng hi·ªÉn th·ªã ph·ª• ·ªü ƒë√¢y
        
        document.getElementById('alphaTotalVND').innerText = alphaTotalVND.toLocaleString('vi-VN') + ' ‚Ç´';
        
        const pBadge = document.getElementById('profitBadge');
        pBadge.innerText = `L√£i r√≤ng: ${(profitUSD>0?'+':'') + profitUSD.toLocaleString('en-US')} $`;
        pBadge.className = profitUSD < 0 ? 'profit-badge neg' : 'profit-badge';
    }

    // --- UNDO ---
    function pushUndo() {
        window.undoStack.push(JSON.parse(JSON.stringify(window.dataStore)));
        if(window.undoStack.length > 10) window.undoStack.shift();
        renderUndoBtn();
    }
    window.execUndo = function() {
        if(window.undoStack.length > 0) {
            window.dataStore = window.undoStack.pop(); syncToCloud(); renderUndoBtn();
        }
    }
    function renderUndoBtn() {
        const btn = document.getElementById('btnUndo');
        if(window.undoStack.length>0) { btn.classList.add('active'); btn.innerText=`‚Ü© (${window.undoStack.length})`; }
        else { btn.classList.remove('active'); btn.innerText=`‚Ü© Undo`; }
    }

    // --- ACTIONS ---
    function getToday() { const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }

    window.spend10 = function() {
        pushUndo(); const k=getToday();
        const cur = window.dataStore[k] || {in:0,out:0};
        window.dataStore[k] = { in: cur.in, out: parseFloat(cur.out)+10 };
        syncToCloud();
    }
    window.saveQuick = function() {
        const inc=parseFloat(document.getElementById('quickIn').value)||0;
        const exp=parseFloat(document.getElementById('quickOut').value)||0;
        if(inc==0 && exp==0) return;
        pushUndo(); const k=getToday();
        const cur = window.dataStore[k] || {in:0,out:0};
        window.dataStore[k] = { in: parseFloat(cur.in)+inc, out: parseFloat(cur.out)+exp };
        document.getElementById('quickIn').value=''; document.getElementById('quickOut').value='';
        syncToCloud();
    }

    // --- EXCEL EXPORT (C·∫¨P NH·∫¨T) ---
    window.exportToExcel = function() {
        if(!window.dataStore || Object.keys(window.dataStore).length===0) { alert("Ch∆∞a c√≥ d·ªØ li·ªáu!"); return; }
        const { bank, mi11, k60, n7, alpha, rate } = window.configStore;
        
        // T√≠nh l·∫°i t·ªïng ƒë·ªÉ ghi v√†o Excel
        let tIn = 0, tOut = 0;
        for (let k in window.dataStore) { tIn += parseFloat(window.dataStore[k].in)||0; tOut += parseFloat(window.dataStore[k].out)||0; }
        const profit = tIn - tOut;
        const alphaTotalVND = (alpha + profit) * rate;
        const mainTotalVND = bank + (mi11 + k60 + n7) * rate;

        const data = [
            ["B√ÅO C√ÅO T√ÄI CH√çNH CHI TI·∫æT"],
            ["Ng√†y xu·∫•t:", new Date().toLocaleDateString('vi-VN')],
            [],
            ["1. T·ªîNG S·ªê D∆Ø HI·ªÜN T·∫†I (Bank + 3 USD)", mainTotalVND],
            ["   - S·ªë d∆∞ Bank (VND):", bank],
            ["   - USD Mi 11:", mi11],
            ["   - USD K60:", k60],
            ["   - USD N7:", n7],
            [],
            ["2. HI·ªÜU QU·∫¢ ALPHA"],
            ["   - V·ªën Alpha:", alpha],
            ["   - L√£i R√≤ng ($):", profit],
            ["   - T·ªïng Alpha Quy ƒê·ªïi (VND):", alphaTotalVND],
            [],
            ["3. T·ª∂ GI√Å √ÅP D·ª§NG", rate],
            [],
            ["4. CHI TI·∫æT GIAO D·ªäCH"],
            ["Ng√†y", "Thu ($)", "Chi ($)", "L·ª£i nhu·∫≠n ($)", "Quy ƒë·ªïi (VND)"]
        ];

        const keys = Object.keys(window.dataStore).sort((a,b)=>new Date(a)-new Date(b));
        keys.forEach(key => {
           const item = window.dataStore[key];
           const prof = (parseFloat(item.in)||0)-(parseFloat(item.out)||0);
           data.push([key, item.in, item.out, prof, prof*rate]);
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Baocao");
        XLSX.writeFile(wb, "TaiChinh_Ultimate.xlsx");
    }

    // --- UI HELPERS ---
    window.toggleCal = function() { const el=document.getElementById
