<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω T√†i Ch√≠nh Ultimate Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.97);
            --green: #00b894;
            --red: #d63031;
            --blue: #0984e3;
            --purple: #6c5ce7;
            --orange: #fdcb6e;
            --dark: #2d3436;
            --text-sub: #636e72;
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --shadow-sm: 0 4px 12px 0 rgba(0, 0, 0, 0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            margin: 0; 
            padding: 15px;
            min-height: 100vh;
            color: var(--dark);
        }

        .app-container { 
            width: 100%; 
            max-width: 900px; 
            margin: 0 auto;
            position: relative;
        }

        /* HEADER STYLES */
        .app-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
        }

        .app-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            margin: 0 0 5px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .app-subtitle {
            font-size: 12px;
            color: var(--text-sub);
            font-weight: 400;
        }

        .last-sync {
            font-size: 11px;
            color: #636e72;
            margin-top: 5px;
            text-align: center;
        }

        /* GLASS CARD */
        .glass-card {
            background: var(--glass);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 20px; 
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2);
        }

        /* DASHBOARD HEADER */
        .dashboard-header { 
            margin-bottom: 20px; 
            border-bottom: 1px solid #dfe6e9; 
            padding-bottom: 15px; 
        }
        
        .balance-group { 
            margin-bottom: 15px; 
        }
        
        .balance-label { 
            font-size: 11px; 
            text-transform: uppercase; 
            color: var(--text-sub); 
            font-weight: 700; 
            letter-spacing: 0.5px; 
            margin-bottom: 4px;
        }
        
        .balance-total { 
            font-size: 28px; 
            font-weight: 700; 
            color: var(--dark); 
            margin: 0; 
            line-height: 1.2; 
        }
        
        .alpha-box {
            background: rgba(108, 92, 231, 0.1); 
            padding: 15px; 
            border-radius: 12px;
            margin-top: 15px; 
            border: 1px solid rgba(108, 92, 231, 0.2);
        }
        
        .alpha-total { 
            font-size: 20px; 
            font-weight: 700; 
            color: var(--purple); 
            margin: 5px 0;
        }

        .profit-badge {
            display: inline-block; 
            padding: 6px 12px; 
            border-radius: 10px; 
            font-size: 12px; 
            font-weight: 700;
            background: rgba(0, 184, 148, 0.15); 
            color: var(--green); 
            margin-top: 8px;
            border: 1px solid rgba(0, 184, 148, 0.3);
        }
        
        .profit-badge.neg { 
            background: rgba(214, 48, 49, 0.15); 
            color: var(--red); 
            border-color: rgba(214, 48, 49, 0.3);
        }

        /* INPUTS GRID */
        .assets-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px;
            margin-top: 10px;
        }
        
        .input-group { 
            position: relative; 
        }
        
        .input-label { 
            font-size: 10px; 
            font-weight: 700; 
            color: var(--text-sub); 
            margin-bottom: 5px; 
            display: block; 
        }
        
        .modern-input {
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid #dfe6e9; 
            border-radius: 10px;
            font-size: 14px; 
            font-weight: 600; 
            outline: none; 
            background: #fdfdfd; 
            transition: 0.3s;
        }
        
        .modern-input:focus { 
            border-color: var(--blue); 
            background: white; 
            box-shadow: 0 0 0 3px rgba(9, 132, 227, 0.1);
        }
        
        .inp-vnd { 
            border-left: 4px solid var(--green); 
        }
        
        .inp-usd { 
            border-left: 4px solid var(--orange); 
        }
        
        .inp-alpha { 
            border-left: 4px solid var(--purple); 
        }

        /* BUTTONS */
        .input-with-button {
            display: flex; 
            gap: 8px;
            align-items: center;
        }
        
        .input-with-button input {
            flex: 1;
        }
        
        .btn {
            border: none; 
            padding: 10px 15px; 
            border-radius: 10px; 
            font-weight: 600; 
            cursor: pointer;
            font-size: 12px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s;
            gap: 5px;
            white-space: nowrap;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .btn:active { 
            transform: scale(0.98); 
        }
        
        .btn-blue { 
            background: var(--blue); 
            color: white; 
        }
        
        .btn-green { 
            background: var(--green); 
            color: white; 
        }
        
        .btn-red { 
            background: var(--red); 
            color: white; 
        }
        
        .btn-orange { 
            background: var(--orange); 
            color: #d35400; 
        }
        
        .btn-purple { 
            background: var(--purple); 
            color: white; 
        }
        
        .btn-gray { 
            background: #b2bec3; 
            color: white; 
        }
        
        .btn-small {
            padding: 6px 10px;
            font-size: 11px;
            min-width: 40px;
        }

        /* QUICK ACTIONS */
        .quick-actions { 
            display: flex; 
            gap: 10px; 
            margin-top: 20px; 
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn-full {
            width: 100%;
            padding: 12px;
            font-size: 13px;
        }

        /* MONTHLY STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #f1f2f6;
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            border-color: var(--blue);
            transform: translateY(-3px);
        }
        
        .stat-value {
            font-size: 22px;
            font-weight: 700;
            margin: 5px 0;
        }
        
        .stat-in { color: var(--green); }
        .stat-out { color: var(--red); }
        .stat-profit { color: var(--blue); }

        /* CALENDAR */
        .toggle-bar {
            text-align: center; 
            background: rgba(255,255,255,0.6); 
            padding: 12px; 
            color: var(--dark);
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 13px; 
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .toggle-bar:hover {
            background: rgba(255,255,255,0.8);
            border-color: var(--blue);
        }
        
        #calendarSection { 
            display: none; 
            animation: fadeIn 0.5s ease;
        }
        
        .calendar-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        
        .cal-nav { 
            background: white; 
            border: none; 
            border-radius: 50%; 
            width: 36px; 
            height: 36px; 
            cursor: pointer; 
            font-weight: bold; 
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .cal-nav:hover {
            background: var(--blue);
            color: white;
            transform: scale(1.1);
        }

        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 6px; 
        }
        
        .day-header { 
            text-align: center; 
            font-size: 11px; 
            font-weight: 700; 
            color: #b2bec3; 
            margin-bottom: 5px; 
            padding: 5px;
        }

        .day-card {
            background: white; 
            border-radius: 10px; 
            min-height: 65px; 
            padding: 6px; 
            border: 1px solid #f1f2f6; 
            cursor: pointer; 
            position: relative;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            transition: all 0.2s;
        }
        
        .day-card:hover { 
            border-color: var(--blue); 
            transform: translateY(-2px); 
            z-index: 2; 
            box-shadow: 0 6px 15px rgba(0,0,0,0.08); 
        }
        
        .day-card.today { 
            background: #e3f2fd; 
            border-color: var(--blue); 
            border-width: 2px;
        }
        
        .day-card.has-data {
            background: #f9f9f9;
        }
        
        .day-number {
            font-size: 11px; 
            font-weight: 700; 
            color: #636e72; 
            margin-bottom: 3px;
        }
        
        .day-card.today .day-number {
            color: var(--blue);
            font-weight: 800;
        }
        
        .val-txt { 
            font-size: 9px; 
            font-weight: 700; 
            text-align: right; 
            display: block; 
            line-height: 1.2; 
            margin-top: 2px;
        }
        
        .c-green { 
            color: var(--green); 
        }
        
        .c-red { 
            color: var(--red); 
        }

        /* MODAL */
        .modal-overlay {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.6); 
            z-index: 1000; 
            justify-content: center; 
            align-items: center; 
            backdrop-filter: blur(3px);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content { 
            background: white; 
            width: 320px; 
            max-width: 90%; 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 15px 50px rgba(0,0,0,0.25);
            animation: slideUp 0.3s ease;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* CHART */
        .chart-container {
            height: 200px;
            margin-top: 15px;
            position: relative;
        }

        /* STATUS INDICATOR */
        #statusIndicator {
            position: fixed; 
            bottom: 15px; 
            right: 15px; 
            font-size: 11px; 
            background: var(--dark); 
            color: white; 
            padding: 8px 15px; 
            border-radius: 20px; 
            opacity: 0; 
            transition: opacity 0.5s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 100;
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid #dfe6e9;
            padding-bottom: 5px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 8px 15px;
            background: none;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-sub);
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab-btn.active {
            background: var(--blue);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        /* LOGS STYLES */
        .logs-container {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 10px;
            background: #f8f9fa;
            padding: 10px;
            margin-top: 10px;
        }
        
        .log-entry {
            background: white;
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-left: 4px solid var(--blue);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 11px;
            line-height: 1.4;
        }
        
        .log-entry.success {
            border-left-color: var(--green);
        }
        
        .log-entry.warning {
            border-left-color: var(--orange);
        }
        
        .log-entry.error {
            border-left-color: var(--red);
        }
        
        .log-entry.info {
            border-left-color: var(--blue);
        }
        
        .log-time {
            font-size: 9px;
            color: var(--text-sub);
            font-weight: 600;
            margin-bottom: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-action {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 2px;
        }
        
        .log-details {
            color: #555;
            margin-top: 3px;
        }
        
        .log-old-value {
            color: var(--red);
            font-weight: 600;
        }
        
        .log-new-value {
            color: var(--green);
            font-weight: 600;
        }
        
        .log-diff {
            display: inline-block;
            padding: 1px 5px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
            margin-left: 5px;
        }
        
        .log-diff.positive {
            background: rgba(0, 184, 148, 0.15);
            color: var(--green);
        }
        
        .log-diff.negative {
            background: rgba(214, 48, 49, 0.15);
            color: var(--red);
        }
        
        .logs-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid #dfe6e9;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-btn.active {
            background: var(--blue);
            color: white;
            border-color: var(--blue);
        }
        
        .logs-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .log-stat {
            background: white;
            padding: 10px;
            border-radius: 8px;
            flex: 1;
            min-width: 120px;
            text-align: center;
            border: 1px solid #dfe6e9;
        }
        
        .log-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .log-stat-label {
            font-size: 10px;
            color: var(--text-sub);
            margin-top: 3px;
        }

        /* ANIMATIONS */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .assets-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .quick-actions .btn {
                width: 100%;
            }
            
            .calendar-grid {
                gap: 4px;
            }
            
            .day-card {
                min-height: 55px;
                padding: 4px;
            }
            
            .app-title {
                font-size: 20px;
            }
            
            .tabs {
                overflow-x: auto;
                padding-bottom: 3px;
            }
            
            .tab-btn {
                padding: 6px 10px;
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .glass-card {
                padding: 15px;
            }
            
            .balance-total {
                font-size: 24px;
            }
            
            .alpha-total {
                font-size: 18px;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
            }
            
            .day-card {
                min-height: 50px;
            }
        }

        /* UTILITY CLASSES */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mb-10 { margin-bottom: 10px; }
        .mt-10 { margin-top: 10px; }
        .mb-15 { margin-bottom: 15px; }
        .mt-15 { margin-top: 15px; }
        .mb-20 { margin-bottom: 20px; }
        .mt-20 { margin-top: 20px; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-5 { gap: 5px; }
        .gap-10 { gap: 10px; }
        .gap-15 { gap: 15px; }
        .w-full { width: 100%; }
        .hidden { display: none; }

    </style>
</head>
<body>

<div class="app-container">
    
    <!-- HEADER -->
    <div class="app-header">
        <h1 class="app-title">üí∞ Qu·∫£n L√Ω T√†i Ch√≠nh Ultimate Pro</h1>
        <div class="app-subtitle">Qu·∫£n l√Ω t√†i ch√≠nh c√° nh√¢n th√¥ng minh & tr·ª±c quan</div>
        <div id="lastSync" class="last-sync">ƒêang k·∫øt n·ªëi...</div>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('dashboard')">üìä T·ªïng quan</button>
        <button class="tab-btn" onclick="switchTab('calendar')">üìÖ L·ªãch s·ª≠</button>
        <button class="tab-btn" onclick="switchTab('analytics')">üìà Th·ªëng k√™</button>
        <button class="tab-btn" onclick="switchTab('logs')">üìù Logs</button>
    </div>

    <!-- DASHBOARD TAB -->
    <div id="dashboardTab" class="tab-content active">
        
        <!-- T·ªîNG QUAN T√ÄI CH√çNH -->
        <div class="glass-card">
            <div class="dashboard-header">
                <div class="balance-group">
                    <div class="balance-label">T·ªîNG S·ªê D∆Ø HI·ªÜN T·∫†I</div>
                    <div class="balance-total" id="totalBalanceVND">0 ‚Ç´</div>
                    <small style="color: var(--text-sub);">T·ªïng s·ªë d∆∞ t·ª´ t·∫•t c·∫£ t√†i kho·∫£n</small>
                </div>

                <div class="alpha-box">
                    <div class="balance-label" style="color: var(--purple)">üìà T√ÄI S·∫¢N ALPHA</div>
                    <div class="alpha-total" id="alphaTotalVND">0 ‚Ç´</div>
                    <div id="profitBadge" class="profit-badge">L√£i th√°ng: ƒêang t√≠nh...</div>
                </div>
            </div>

            <!-- C√ÅC KHO·∫¢N T√ÄI S·∫¢N -->
            <div class="assets-grid">
                <!-- BANK -->
                <div class="input-group">
                    <label class="input-label">üè¶ S·ªë d∆∞ Ng√¢n h√†ng (VND)</label>
                    <div class="input-with-button">
                        <button class="btn btn-red btn-small" onclick="changeBank(-1)" title="Tr·ª´ t·ª´ t√†i kho·∫£n">-</button>
                        <input type="number" id="bankBalance" class="modern-input inp-vnd" placeholder="Nh·∫≠p s·ªë d∆∞..." onchange="saveConfig()">
                        <button class="btn btn-green btn-small" onclick="changeBank(1)" title="C·ªông v√†o t√†i kho·∫£n">+</button>
                    </div>
                </div>

                <!-- T·ª∂ GI√Å -->
                <div class="input-group">
                    <label class="input-label">üí± T·ª∑ gi√° USD/VND</label>
                    <input type="number" id="exchangeRate" class="modern-input" onchange="saveConfig()" min="1" step="100">
                </div>

                <!-- USD MI 11 -->
                <div class="input-group">
                    <label class="input-label">üì± USD Mi 11</label>
                    <div class="input-with-button">
                        <input type="number" id="usdMi11" class="modern-input inp-usd" placeholder="$..." onchange="saveConfig()">
                        <button class="btn btn-orange btn-small" onclick="addUSD('usdMi11')" title="Th√™m USD">+</button>
                    </div>
                </div>

                <!-- USD K60 -->
                <div class="input-group">
                    <label class="input-label">üíª USD K60</label>
                    <div class="input-with-button">
                        <input type="number" id="usdK60" class="modern-input inp-usd" placeholder="$..." onchange="saveConfig()">
                        <button class="btn btn-orange btn-small" onclick="addUSD('usdK60')" title="Th√™m USD">+</button>
                    </div>
                </div>

                <!-- USD N7 -->
                <div class="input-group">
                    <label class="input-label">üì± USD N7</label>
                    <div class="input-with-button">
                        <input type="number" id="usdN7" class="modern-input inp-usd" placeholder="$..." onchange="saveConfig()">
                        <button class="btn btn-orange btn-small" onclick="addUSD('usdN7')" title="Th√™m USD">+</button>
                    </div>
                </div>

                <!-- V·ªêN ALPHA -->
                <div class="input-group">
                    <label class="input-label" style="color: var(--purple)">‚öõÔ∏è V·ªën Alpha ($)</label>
                    <input type="number" id="usdAlpha" class="modern-input inp-alpha" onchange="saveConfig()" min="0">
                </div>
            </div>
        </div>

        <!-- GIAO D·ªäCH NHANH -->
        <div class="glass-card">
            <div class="input-label" style="margin-bottom:10px;">‚ö° GIAO D·ªäCH NHANH H√îM NAY (ALPHA $)</div>
            <div class="flex gap-10 mb-15">
                <input type="number" id="quickIn" class="modern-input" placeholder="+ Thu ($)" style="border-color: #00b894;">
                <input type="number" id="quickOut" class="modern-input" placeholder="- Chi ($)" style="border-color: #d63031;">
            </div>
            
            <div class="quick-actions">
                <button class="btn btn-blue" onclick="saveQuick()">
                    üíæ L∆∞u Giao D·ªãch
                </button>
                <button class="btn btn-orange" onclick="spend10()">
                    ‚ö° Chi 10$
                </button>
                <button id="btnUndo" class="btn btn-gray" onclick="execUndo()" title="Ho√†n t√°c thao t√°c g·∫ßn nh·∫•t">
                    ‚Ü© Undo
                </button>
            </div>
        </div>

        <!-- TH·ªêNG K√ä TH√ÅNG -->
        <div class="glass-card">
            <div class="input-label mb-10">üìä TH·ªêNG K√ä TH√ÅNG <span id="currentMonthText">HI·ªÜN T·∫†I</span> (ALPHA $)</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="balance-label">T·ªîNG THU</div>
                    <div class="stat-value stat-in" id="monthIn">0 $</div>
                    <small style="color: var(--text-sub);">Thu nh·∫≠p trong th√°ng</small>
                </div>
                <div class="stat-card">
                    <div class="balance-label">T·ªîNG CHI</div>
                    <div class="stat-value stat-out" id="monthOut">0 $</div>
                    <small style="color: var(--text-sub);">Chi ti√™u trong th√°ng</small>
                </div>
                <div class="stat-card">
                    <div class="balance-label">L√ÉI / L·ªñ</div>
                    <div class="stat-value stat-profit" id="monthProfit">0 $</div>
                    <small style="color: var(--text-sub);">L·ª£i nhu·∫≠n r√≤ng</small>
                </div>
            </div>
        </div>

        <!-- XU·∫§T EXCEL -->
        <button class="btn btn-green btn-full" onclick="exportToExcel()">
            üìä Xu·∫•t B√°o C√°o Excel
        </button>

    </div>

    <!-- CALENDAR TAB -->
    <div id="calendarTab" class="tab-content">
        <div class="glass-card">
            <div class="calendar-header">
                <button class="cal-nav" onclick="changeMonth(-1)">‚ùÆ</button>
                <span style="font-weight:700; font-size:16px;" id="monthDisplay">12/2025</span>
                <button class="cal-nav" onclick="changeMonth(1)">‚ùØ</button>
            </div>
            
            <div class="flex justify-between items-center mb-15">
                <small onclick="restoreData()" style="color:#0984e3; cursor:pointer; font-size:12px; text-decoration: underline;">
                    üîÑ Kh√¥i ph·ª•c d·ªØ li·ªáu m·∫´u
                </small>
                <small onclick="clearMonthData()" style="color:#d63031; cursor:pointer; font-size:12px;">
                    üóëÔ∏è X√≥a d·ªØ li·ªáu th√°ng n√†y
                </small>
            </div>

            <div class="calendar-grid" id="calendar"></div>
        </div>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="analyticsTab" class="tab-content">
        <div class="glass-card">
            <div class="input-label mb-15">üìà BI·ªÇU ƒê·ªí THU CHI THEO TH√ÅNG</div>
            <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>

        <div class="glass-card">
            <div class="input-label mb-15">üìã T·ªîNG H·ª¢P NƒÇM <span id="currentYear">2025</span></div>
            <div id="yearSummary" style="font-size: 13px;">
                ƒêang t·∫£i d·ªØ li·ªáu...
            </div>
        </div>
    </div>

    <!-- LOGS TAB -->
    <div id="logsTab" class="tab-content">
        <div class="glass-card">
            <div class="input-label mb-15">üìù L·ªäCH S·ª¨ THAY ƒê·ªîI D·ªÆ LI·ªÜU</div>
            
            <div class="flex justify-between items-center mb-10">
                <div style="font-size: 11px; color: var(--text-sub);">
                    T·ªïng s·ªë: <span id="totalLogs">0</span> logs
                </div>
                <div class="flex gap-5">
                    <button class="btn btn-small btn-gray" onclick="clearLogs()" title="X√≥a t·∫•t c·∫£ logs">
                        üóëÔ∏è X√≥a logs
                    </button>
                </div>
            </div>
            
            <div class="logs-container" id="logsList">
                <!-- Logs s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                <div style="text-align: center; padding: 20px; color: var(--text-sub);">
                    <div>üìù</div>
                    <div>ƒêang t·∫£i logs...</div>
                </div>
            </div>
            
            <div class="flex justify-between mt-10">
                <button class="btn btn-small btn-gray" onclick="loadMoreLogs()" id="loadMoreBtn">
                    üì• T·∫£i th√™m
                </button>
                <div style="font-size: 10px; color: var(--text-sub);">
                    Logs ƒë∆∞·ª£c l∆∞u vƒ©nh vi·ªÖn tr√™n Firebase
                </div>
            </div>
        </div>
    </div>

</div>

<!-- MODAL EDIT -->
<div class="modal-overlay" id="inputModal">
    <div class="modal-content">
        <h4 id="modalTitle" style="margin-top:0; text-align:center;">‚úèÔ∏è S·ª≠a giao d·ªãch ng√†y <span id="modalDate"></span></h4>
        
        <div class="mb-15">
            <label class="input-label">üì• Thu nh·∫≠p ($)</label>
            <input type="number" id="modalIn" class="modern-input" placeholder="S·ªë ti·ªÅn thu..." step="0.01">
        </div>
        
        <div class="mb-20">
            <label class="input-label">üì§ Chi ti√™u ($)</label>
            <input type="number" id="modalOut" class="modern-input" placeholder="S·ªë ti·ªÅn chi..." step="0.01">
        </div>
        
        <div class="modal-actions">
            <button class="btn btn-blue" onclick="saveModal()">
                üíæ L∆∞u thay ƒë·ªïi
            </button>
            <button class="btn btn-gray" onclick="closeModal()">
                ‚úñÔ∏è ƒê√≥ng
            </button>
        </div>
    </div>
</div>

<!-- STATUS INDICATOR -->
<div id="statusIndicator">ƒêang ƒë·ªìng b·ªô...</div>

<script type="module">
    // ========== C·∫§U H√åNH V√Ä BI·∫æN TO√ÄN C·ª§C ==========
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBk5BR4mtmv1Mcj4gYrbCKLwNiC5fhKlj4",
        authDomain: "thu-nhap-6be80.firebaseapp.com",
        databaseURL: "https://thu-nhap-6be80-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "thu-nhap-6be80",
        storageBucket: "thu-nhap-6be80.firebasestorage.app",
        messagingSenderId: "482191171526",
        appId: "1:482191171526:web:358e486e9d28f194469cc7",
        measurementId: "G-0B436SXQ0P"
    };

    // State Management
    window.dataStore = {};
    window.configStore = {
        bank: 0,
        mi11: 0,
        k60: 0,
        n7: 0,
        alpha: 10206,
        rate: 27000
    };
    
    window.undoStack = [];
    window.currentDate = new Date();
    window.chart = null;
    
    // Logs System
    window.logsStore = [];
    window.logsLimit = 50;
    window.logsOffset = 0;

    // ========== KH·ªûI T·∫†O FIREBASE ==========
    let app, db;
    
    function initFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            console.log("‚úÖ Firebase ƒë√£ k·∫øt n·ªëi");
            loadFirebaseData();
        } catch (e) {
            console.error("‚ùå L·ªói Firebase:", e);
            showStatus("‚ùå L·ªói k·∫øt n·ªëi Firebase", 5000);
        }
    }

    function loadFirebaseData() {
        if (!db) return;
        
        showStatus("üîÑ ƒêang t·∫£i d·ªØ li·ªáu...");
        
        // Load Configuration - REAL-TIME LISTENER
        onValue(ref(db, 'config'), (snap) => {
            const val = snap.val();
            if (val) {
                window.configStore = val;
                updateConfigUI();
                updateCalculations();
                showStatus("‚úÖ ƒê√£ t·∫£i c·∫•u h√¨nh", 2000);
            } else {
                // N·∫øu ch∆∞a c√≥ config, t·∫°o m·∫´u v√† l∆∞u l√™n Firebase
                window.configStore = {
                    bank: 0,
                    mi11: 0,
                    k60: 0,
                    n7: 0,
                    alpha: 10206,
                    rate: 27000
                };
                syncConfig();
            }
        });
        
        // Load Transaction Data - REAL-TIME LISTENER
        onValue(ref(db, 'data'), (snap) => {
            const val = snap.val();
            if (val) {
                window.dataStore = val;
            } else {
                // T·∫°o d·ªØ li·ªáu m·∫´u n·∫øu ch∆∞a c√≥
                createSampleData();
            }
            updateCalculations();
            renderCal();
            updateChart();
            updateYearSummary();
            showStatus("‚úÖ ƒê√£ t·∫£i giao d·ªãch", 2000);
            updateLastSync();
        });
        
        // Load Logs - REAL-TIME LISTENER
        onValue(ref(db, 'logs'), (snap) => {
            const val = snap.val();
            if (val && Array.isArray(val)) {
                window.logsStore = val;
                renderLogs();
            } else {
                window.logsStore = [];
                renderLogs();
            }
        });
    }

    function createSampleData() {
        const SAMPLE_DATA = {
            "2025-12-1": { in: 5, out: 10 }, "2025-12-2": { in: 0, out: 10 }, "2025-12-3": { in: 0, out: 10 },
            "2025-12-4": { in: 0, out: 10 }, "2025-12-5": { in: 0, out: 10 }, "2025-12-6": { in: 0, out: 10 },
            "2025-12-7": { in: 0, out: 10 }, "2025-12-8": { in: 150, out: 10 }, "2025-12-9": { in: 50, out: 10 },
            "2025-12-10": { in: 0, out: 10 }, "2025-12-11": { in: 123, out: 13 }, "2025-12-12": { in: 0, out: 10 },
            "2025-12-13": { in: 96.8, out: 10 }, "2025-12-14": { in: 0, out: 10 }, "2025-12-15": { in: 0, out: 10.6 },
            "2025-12-16": { in: 0, out: 10 }, "2025-12-17": { in: 10, out: 10 }, "2025-12-18": { in: 86, out: 10 },
            "2025-12-19": { in: 90.91, out: 10 }, "2025-12-20": { in: 0, out: 10 }, "2025-12-21": { in: 0, out: 10 },
            "2025-12-22": { in: 0, out: 10 }, "2025-12-23": { in: 0, out: 17 }, "2025-12-24": { in: 42, out: 10 },
            "2025-12-25": { in: 0, out: 10 }, "2025-12-26": { in: 0, out: 10 }, "2025-12-27": { in: 0, out: 10 },
            "2025-12-28": { in: 0, out: 10 }, "2025-12-29": { in: 0, out: 10 }, "2025-12-30": { in: 0, out: 10 },
            "2025-12-31": { in: 0, out: 10 }
        };
        
        window.dataStore = SAMPLE_DATA;
        syncToCloud();
    }

    // ========== TI·ªÜN √çCH V√Ä H√ÄM H·ªñ TR·ª¢ ==========
    function showStatus(message, duration = 3000) {
        const indicator = document.getElementById('statusIndicator');
        indicator.innerText = message;
        indicator.style.opacity = 1;
        
        if (duration > 0) {
            setTimeout(() => {
                indicator.style.opacity = 0;
            }, duration);
        }
    }

    function updateLastSync() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('lastSync').innerText = `C·∫≠p nh·∫≠t: ${timeStr}`;
    }

    function validateNumber(value, fieldName = 'gi√° tr·ªã') {
        const num = parseFloat(value);
        if (isNaN(num) || num < 0) {
            throw new Error(`${fieldName} kh√¥ng h·ª£p l·ªá!`);
        }
        return num;
    }

    function formatCurrency(amount, currency = 'VND') {
        if (currency === 'VND') {
            return amount.toLocaleString('vi-VN') + ' ‚Ç´';
        } else {
            return amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' $';
        }
    }

    function getTodayKey() {
        const d = new Date();
        return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
    }

    // ========== QU·∫¢N L√ù D·ªÆ LI·ªÜU ==========
    function syncToCloud() {
        if (!db) {
            showStatus("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi Firebase", 3000);
            return;
        }
        
        showStatus("üîÑ ƒêang ƒë·ªìng b·ªô l√™n Firebase...");
        set(ref(db, 'data'), window.dataStore)
            .then(() => {
                showStatus("‚úÖ ƒê√£ ƒë·ªìng b·ªô d·ªØ li·ªáu", 2000);
                updateLastSync();
            })
            .catch(error => {
                console.error("L·ªói ƒë·ªìng b·ªô:", error);
                showStatus("‚ùå L·ªói ƒë·ªìng b·ªô", 3000);
            });
    }

    function syncConfig() {
        if (!db) return;
        
        set(ref(db, 'config'), window.configStore)
            .catch(error => {
                console.error("L·ªói ƒë·ªìng b·ªô config:", error);
                showStatus("‚ùå L·ªói l∆∞u c·∫•u h√¨nh", 3000);
            });
    }

    function syncLogs() {
        if (!db) return;
        
        set(ref(db, 'logs'), window.logsStore)
            .catch(error => {
                console.error("L·ªói ƒë·ªìng b·ªô logs:", error);
            });
    }

    // ========== C·∫¨P NH·∫¨T GIAO DI·ªÜN ==========
    function updateConfigUI() {
        const config = window.configStore;
        document.getElementById('bankBalance').value = config.bank || 0;
        document.getElementById('usdMi11').value = config.mi11 || 0;
        document.getElementById('usdK60').value = config.k60 || 0;
        document.getElementById('usdN7').value = config.n7 || 0;
        document.getElementById('usdAlpha').value = config.alpha || 10206;
        document.getElementById('exchangeRate').value = config.rate || 27000;
    }

    window.saveConfig = function() {
    // L∆∞u gi√° tr·ªã c≈© ƒë·ªÉ so s√°nh
    const oldBank = window.configStore.bank || 0;
    const oldMi11 = window.configStore.mi11 || 0;
    const oldK60 = window.configStore.k60 || 0;
    const oldN7 = window.configStore.n7 || 0;
    const oldAlpha = window.configStore.alpha || 10206;
    const oldRate = window.configStore.rate || 27000;
    
    // L·∫•y gi√° tr·ªã m·ªõi t·ª´ input
    const newBank = parseFloat(document.getElementById('bankBalance').value) || 0;
    const newMi11 = parseFloat(document.getElementById('usdMi11').value) || 0;
    const newK60 = parseFloat(document.getElementById('usdK60').value) || 0;
    const newN7 = parseFloat(document.getElementById('usdN7').value) || 0;
    const newAlpha = parseFloat(document.getElementById('usdAlpha').value) || 10206;
    const newRate = parseFloat(document.getElementById('exchangeRate').value) || 27000;
    
    // C·∫≠p nh·∫≠t configStore
    window.configStore = {
        bank: newBank,
        mi11: newMi11,
        k60: newK60,
        n7: newN7,
        alpha: newAlpha,
        rate: newRate
    };
    
    // GHI LOGS KHI C√ì THAY ƒê·ªîI
    
    // Log thay ƒë·ªïi s·ªë d∆∞ Bank
    if (oldBank !== newBank) {
        addLog('bank_change', {
            oldValue: oldBank,
            newValue: newBank,
            change: newBank - oldBank,
            message: `Thay ƒë·ªïi s·ªë d∆∞ ng√¢n h√†ng: ${formatCurrency(oldBank, 'VND')} ‚Üí ${formatCurrency(newBank, 'VND')}`
        });
    }
    
    // Log thay ƒë·ªïi USD Mi 11
    if (oldMi11 !== newMi11) {
        addLog('usd_change', {
            field: 'USD Mi 11',
            oldValue: oldMi11,
            newValue: newMi11,
            change: newMi11 - oldMi11,
            message: `Thay ƒë·ªïi USD Mi 11: ${oldMi11}$ ‚Üí ${newMi11}$`
        });
    }
    
    // Log thay ƒë·ªïi USD K60
    if (oldK60 !== newK60) {
        addLog('usd_change', {
            field: 'USD K60',
            oldValue: oldK60,
            newValue: newK60,
            change: newK60 - oldK60,
            message: `Thay ƒë·ªïi USD K60: ${oldK60}$ ‚Üí ${newK60}$`
        });
    }
    
    // Log thay ƒë·ªïi USD N7
    if (oldN7 !== newN7) {
        addLog('usd_change', {
            field: 'USD N7',
            oldValue: oldN7,
            newValue: newN7,
            change: newN7 - oldN7,
            message: `Thay ƒë·ªïi USD N7: ${oldN7}$ ‚Üí ${newN7}$`
        });
    }
    
    // Log thay ƒë·ªïi v·ªën Alpha (n·∫øu c·∫ßn)
    if (oldAlpha !== newAlpha) {
        addLog('alpha_change', {
            oldValue: oldAlpha,
            newValue: newAlpha,
            change: newAlpha - oldAlpha,
            message: `Thay ƒë·ªïi v·ªën Alpha: ${oldAlpha}$ ‚Üí ${newAlpha}$`
        });
    }
    
    // Log thay ƒë·ªïi t·ª∑ gi√° (n·∫øu c·∫ßn)
    if (oldRate !== newRate) {
        addLog('rate_change', {
            oldValue: oldRate,
            newValue: newRate,
            change: newRate - oldRate,
            message: `Thay ƒë·ªïi t·ª∑ gi√°: ${oldRate} ‚Üí ${newRate}`
        });
    }
    
    // ƒê·ªìng b·ªô l√™n Firebase
    syncConfig();
    updateCalculations();
    showStatus("üíæ ƒê√£ l∆∞u c·∫•u h√¨nh", 1500);
    }

    // ========== T√çNH TO√ÅN T√ÄI CH√çNH ==========
    function calcMonthlyProfitUSD(year = null, month = null) {
        const y = year || window.currentDate.getFullYear();
        const m = month || window.currentDate.getMonth() + 1;
        
        let tIn = 0, tOut = 0;
        for (let k in window.dataStore) {
            const [yy, mm] = k.split('-').map(Number);
            if (yy === y && mm === m) {
                tIn += parseFloat(window.dataStore[k].in) || 0;
                tOut += parseFloat(window.dataStore[k].out) || 0;
            }
        }
        return { income: tIn, expense: tOut, profit: tIn - tOut };
    }

    function updateCalculations() {
        // L·∫•y d·ªØ li·ªáu th√°ng hi·ªán t·∫°i
        const monthly = calcMonthlyProfitUSD();
        
        // L·∫•y c·∫•u h√¨nh
        const { bank, mi11, k60, n7, alpha, rate } = window.configStore;
        
        // T√≠nh t·ªïng t√†i s·∫£n
        const sumUsdAssets = mi11 + k60 + n7;
        const totalBalanceVND = bank + (sumUsdAssets * rate);
        
        // T√≠nh t√†i s·∫£n Alpha
        const alphaTotalVND = (alpha + monthly.profit) * rate;
        const profitVND = monthly.profit * rate;
        
        // C·∫≠p nh·∫≠t giao di·ªán
        document.getElementById('totalBalanceVND').innerText = formatCurrency(totalBalanceVND, 'VND');
        document.getElementById('alphaTotalVND').innerText = formatCurrency(alphaTotalVND, 'VND');
        
        // C·∫≠p nh·∫≠t badge l·ª£i nhu·∫≠n
        const pBadge = document.getElementById('profitBadge');
        const m = window.currentDate.getMonth() + 1;
        const y = window.currentDate.getFullYear();
        
        pBadge.innerText = `L√£i th√°ng ${m}/${y}: ${(monthly.profit >= 0 ? '+' : '') + monthly.profit.toFixed(2)} $ (‚âà ${formatCurrency(profitVND, 'VND')})`;
        pBadge.className = monthly.profit < 0 ? 'profit-badge neg' : 'profit-badge';
        
        // C·∫≠p nh·∫≠t th·ªëng k√™ th√°ng
        updateMonthlyStats();
    }

    function updateMonthlyStats() {
        const monthly = calcMonthlyProfitUSD();
        
        document.getElementById('monthIn').innerText = formatCurrency(monthly.income, 'USD');
        document.getElementById('monthOut').innerText = formatCurrency(monthly.expense, 'USD');
        document.getElementById('monthProfit').innerText = 
            (monthly.profit >= 0 ? '+' : '') + formatCurrency(monthly.profit, 'USD');
        
        // C·∫≠p nh·∫≠t text th√°ng hi·ªán t·∫°i
        const monthNames = ['Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6',
                          'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'];
        const currentMonth = window.currentDate.getMonth();
        document.getElementById('currentMonthText').innerText = monthNames[currentMonth];
    }

    // ========== UNDO SYSTEM ==========
    function pushUndo() {
        window.undoStack.push({
            data: JSON.parse(JSON.stringify(window.dataStore)),
            config: JSON.parse(JSON.stringify(window.configStore)),
            timestamp: new Date()
        });
        
        if (window.undoStack.length > 20) {
            window.undoStack.shift();
        }
        
        renderUndoBtn();
    }

    window.execUndo = function() {
        if (window.undoStack.length > 0) {
            const prev = window.undoStack.pop();
            window.dataStore = prev.data;
            window.configStore = prev.config;
            
            updateConfigUI();
            syncToCloud();
            syncConfig();
            updateCalculations();
            renderCal();
            renderUndoBtn();
            
            showStatus("‚Ü© ƒê√£ ho√†n t√°c", 2000);
        }
    }

    function renderUndoBtn() {
        const btn = document.getElementById('btnUndo');
        if (window.undoStack.length > 0) {
            btn.classList.add('active');
            btn.innerText = `‚Ü© Undo (${window.undoStack.length})`;
            btn.title = `Ho√†n t√°c (${window.undoStack.length}) b∆∞·ªõc g·∫ßn nh·∫•t`;
        } else {
            btn.classList.remove('active');
            btn.innerText = `‚Ü© Undo`;
            btn.title = 'Kh√¥ng c√≥ thao t√°c ƒë·ªÉ ho√†n t√°c';
        }
    }

    // ========== QUICK ACTIONS ==========
    window.spend10 = function() {
        pushUndo();
        const k = getTodayKey();
        const cur = window.dataStore[k] || { in: 0, out: 0 };
        window.dataStore[k] = { in: cur.in, out: parseFloat(cur.out) + 10 };
        
        // Ghi log
        addLog('transaction_add', {
            date: k,
            in: 0,
            out: 10,
            message: 'Th√™m chi ph√≠ 10$ t·ª± ƒë·ªông'
        });
        
        syncToCloud();
        updateCalculations();
        renderCal();
        showStatus("‚ö° ƒê√£ th√™m chi ph√≠ 10$", 1500);
    }

    window.saveQuick = function() {
        const inc = parseFloat(document.getElementById('quickIn').value) || 0;
        const exp = parseFloat(document.getElementById('quickOut').value) || 0;
        
        if (inc === 0 && exp === 0) {
            showStatus("‚ÑπÔ∏è Nh·∫≠p s·ªë li·ªáu tr∆∞·ªõc khi l∆∞u", 2000);
            return;
        }
        
        pushUndo();
        const k = getTodayKey();
        const cur = window.dataStore[k] || { in: 0, out: 0 };
        
        window.dataStore[k] = {
            in: parseFloat(cur.in) + inc,
            out: parseFloat(cur.out) + exp
        };
        
        // Ghi log
        addLog('transaction_add', {
            date: k,
            in: inc,
            out: exp,
            message: `Th√™m giao d·ªãch: +${inc}$, -${exp}$`
        });
        
        document.getElementById('quickIn').value = '';
        document.getElementById('quickOut').value = '';
        
        syncToCloud();
        updateCalculations();
        renderCal();
        showStatus("üíæ ƒê√£ l∆∞u giao d·ªãch", 1500);
    }

    window.addUSD = function(inputId) {
    const val = prompt("Nh·∫≠p s·ªë USD mu·ªën c·ªông th√™m:", "0");
    if (val === null) return;
    
    try {
        const add = validateNumber(val, "S·ªë USD");
        pushUndo();
        
        const inp = document.getElementById(inputId);
        const oldValue = parseFloat(inp.value) || 0;
        const newValue = oldValue + add;
        inp.value = newValue;
        
        // G·ªåI saveConfig() ƒë·ªÉ t·ª± ƒë·ªông ghi logs
        saveConfig();
        showStatus(`‚úÖ ƒê√£ th√™m ${add}$`, 1500);
    } catch (error) {
        alert(error.message);
    }
}

    window.changeBank = function(dir) {
    const action = dir > 0 ? "C·ªòNG" : "TR·ª™";
    const val = prompt(`Nh·∫≠p s·ªë VND mu·ªën ${action}:`, "0");
    if (val === null) return;
    
    try {
        const amt = validateNumber(val, "S·ªë ti·ªÅn");
        pushUndo();
        
        const inp = document.getElementById('bankBalance');
        const oldValue = parseFloat(inp.value) || 0;
        const newValue = dir > 0 ? oldValue + amt : oldValue - amt;
        inp.value = newValue;
        
        // G·ªåI saveConfig() ƒë·ªÉ t·ª± ƒë·ªông ghi logs
        saveConfig();
        showStatus(`‚úÖ ƒê√£ ${dir > 0 ? 'c·ªông' : 'tr·ª´'} ${formatCurrency(amt, 'VND')}`, 1500);
    } catch (error) {
        alert(error.message);
    }
}

    // ========== CALENDAR FUNCTIONS ==========
    window.changeMonth = function(s) {
        window.currentDate.setMonth(window.currentDate.getMonth() + s);
        renderCal();
        updateCalculations();
        updateChart();
    }

    window.renderCal = function() {
        const y = window.currentDate.getFullYear();
        const m = window.currentDate.getMonth();
        
        document.getElementById('monthDisplay').innerText = `${m + 1}/${y}`;
        
        const cal = document.getElementById('calendar');
        cal.innerHTML = '';
        
        // Day headers
        ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'].forEach(d => {
            cal.innerHTML += `<div class="day-header">${d}</div>`;
        });
        
        // Empty cells for days before 1st
        const firstDay = new Date(y, m, 1).getDay();
        for (let i = 0; i < firstDay; i++) {
            cal.innerHTML += `<div></div>`;
        }
        
        // Days of the month
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        const today = new Date();
        
        for (let i = 1; i <= daysInMonth; i++) {
            const k = `${y}-${m + 1}-${i}`;
            const d = window.dataStore[k] || { in: 0, out: 0 };
            const isToday = today.getFullYear() === y && 
                           today.getMonth() === m && 
                           today.getDate() === i;
            const hasData = d.in > 0 || d.out > 0;
            
            let dayClass = 'day-card';
            if (isToday) dayClass += ' today';
            if (hasData) dayClass += ' has-data';
            
            let htmlVal = `<div class="day-number">${i}</div>`;
            
            if (d.in > 0) {
                htmlVal += `<span class="val-txt c-green">+${parseFloat(d.in).toFixed(1)}</span>`;
            }
            if (d.out > 0) {
                htmlVal += `<span class="val-txt c-red">-${parseFloat(d.out).toFixed(1)}</span>`;
            }
            
            cal.innerHTML += `<div class="${dayClass}" onclick="openMod('${k}')">${htmlVal}</div>`;
        }
    }

    // ========== MODAL FUNCTIONS ==========
    let selKey = null;

    window.openMod = function(k) {
        selKey = k;
        const val = window.dataStore[k] || { in: '', out: '' };
        
        // Parse date for display
        const [y, m, d] = k.split('-').map(Number);
        const dateStr = `${d}/${m}/${y}`;
        
        document.getElementById('modalDate').innerText = dateStr;
        document.getElementById('modalIn').value = val.in || '';
        document.getElementById('modalOut').value = val.out || '';
        document.getElementById('inputModal').style.display = 'flex';
    }

    window.closeModal = function() {
        document.getElementById('inputModal').style.display = 'none';
    }

    window.saveModal = function() {
        pushUndo();
        
        const inc = parseFloat(document.getElementById('modalIn').value) || 0;
        const exp = parseFloat(document.getElementById('modalOut').value) || 0;
        const oldData = window.dataStore[selKey] || { in: 0, out: 0 };
        
        if (inc === 0 && exp === 0) {
            // X√≥a giao d·ªãch
            delete window.dataStore[selKey];
            
            // Ghi log x√≥a
            addLog('transaction_delete', {
                date: selKey,
                oldIn: oldData.in,
                oldOut: oldData.out,
                message: `X√≥a giao d·ªãch ng√†y ${selKey}`
            });
        } else {
            // C·∫≠p nh·∫≠t giao d·ªãch
            window.dataStore[selKey] = { in: inc, out: exp };
            
            // Ghi log s·ª≠a
            addLog('transaction_edit', {
                date: selKey,
                oldIn: oldData.in || 0,
                oldOut: oldData.out || 0,
                newIn: inc,
                newOut: exp,
                message: `S·ª≠a giao d·ªãch ng√†y ${selKey}: ${oldData.in || 0}$/${oldData.out || 0}$ ‚Üí ${inc}$/${exp}$`
            });
        }
        
        syncToCloud();
        updateCalculations();
        renderCal();
        closeModal();
        showStatus("üíæ ƒê√£ c·∫≠p nh·∫≠t giao d·ªãch", 1500);
    }

    // ========== LOGS SYSTEM ==========
    
    // H√†m ghi log
    function addLog(action, details) {
        const logEntry = {
            id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
            timestamp: new Date().toISOString(),
            action: action,
            details: details
        };
        
        window.logsStore.unshift(logEntry); // Th√™m v√†o ƒë·∫ßu m·∫£ng
        
        // ƒê·ªìng b·ªô logs l√™n Firebase ngay l·∫≠p t·ª©c
        syncLogs();
        
        // C·∫≠p nh·∫≠t UI n·∫øu ƒëang ·ªü tab logs
        if (document.getElementById('logsTab').classList.contains('active')) {
            renderLogs();
        }
        
        return logEntry;
    }
    
    // Render logs ra UI
    function renderLogs() {
        const logsList = document.getElementById('logsList');
        if (!logsList) return;
        
        // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng hi·ªÉn th·ªã
        const logsToShow = window.logsStore.slice(window.logsOffset, window.logsOffset + window.logsLimit);
        
        // C·∫≠p nh·∫≠t t·ªïng s·ªë logs
        document.getElementById('totalLogs').textContent = window.logsStore.length;
        
        // Render logs
        if (logsToShow.length === 0) {
            logsList.innerHTML = `
                <div style="text-align: center; padding: 30px; color: var(--text-sub);">
                    <div>üì≠</div>
                    <div>Kh√¥ng c√≥ logs n√†o</div>
                </div>
            `;
            return;
        }
        
        let logsHTML = '';
        
        logsToShow.forEach(log => {
            const logTime = new Date(log.timestamp);
            const timeStr = logTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            const dateStr = logTime.toLocaleDateString('vi-VN');
            
            let logClass = 'log-entry';
            let icon = 'üìù';
            let actionText = '';
            let detailsHTML = '';
            
            // X√°c ƒë·ªãnh lo·∫°i log v√† icon
            switch(log.action) {
                case 'bank_change':
                    logClass += ' info';
                    icon = 'üè¶';
                    actionText = 'Thay ƒë·ªïi s·ªë d∆∞ ng√¢n h√†ng';
                    if (log.details.oldValue !== undefined && log.details.newValue !== undefined) {
                        const diff = log.details.newValue - log.details.oldValue;
                        const diffClass = diff >= 0 ? 'positive' : 'negative';
                        detailsHTML = `
                            <div class="log-details">
                                <span class="log-old-value">${formatCurrency(log.details.oldValue, 'VND')}</span> 
                                ‚Üí 
                                <span class="log-new-value">${formatCurrency(log.details.newValue, 'VND')}</span>
                                <span class="log-diff ${diffClass}">${diff >= 0 ? '+' : ''}${formatCurrency(diff, 'VND')}</span>
                            </div>
                        `;
                    }
                    break;
                    
                case 'usd_change':
                    logClass += ' info';
                    icon = 'üíµ';
                    actionText = `Thay ƒë·ªïi ${log.details.field || 'USD'}`;
                    if (log.details.oldValue !== undefined && log.details.newValue !== undefined) {
                        const diff = log.details.newValue - log.details.oldValue;
                        const diffClass = diff >= 0 ? 'positive' : 'negative';
                        detailsHTML = `
                            <div class="log-details">
                                <span class="log-old-value">${log.details.oldValue} $</span> 
                                ‚Üí 
                                <span class="log-new-value">${log.details.newValue} $</span>
                                <span class="log-diff ${diffClass}">${diff >= 0 ? '+' : ''}${diff.toFixed(2)} $</span>
                            </div>
                        `;
                    }
                    break;
                    
                case 'alpha_change':
                    logClass += ' info';
                    icon = '‚öõÔ∏è';
                    actionText = 'Thay ƒë·ªïi v·ªën Alpha';
                    if (log.details.oldValue !== undefined && log.details.newValue !== undefined) {
                        const diff = log.details.newValue - log.details.oldValue;
                        const diffClass = diff >= 0 ? 'positive' : 'negative';
                        detailsHTML = `
                            <div class="log-details">
                                <span class="log-old-value">${log.details.oldValue} $</span> 
                                ‚Üí 
                                <span class="log-new-value">${log.details.newValue} $</span>
                                <span class="log-diff ${diffClass}">${diff >= 0 ? '+' : ''}${diff.toFixed(2)} $</span>
                            </div>
                        `;
                    }
                    break;
                    
                case 'transaction_add':
                    logClass += ' success';
                    icon = '‚ûï';
                    actionText = 'Th√™m giao d·ªãch';
                    detailsHTML = `
                        <div class="log-details">
                            Ng√†y: ${log.details.date || 'N/A'}<br>
                            Thu: ${log.details.in || 0} $ | Chi: ${log.details.out || 0} $
                        </div>
                    `;
                    break;
                    
                case 'transaction_edit':
                    logClass += ' warning';
                    icon = '‚úèÔ∏è';
                    actionText = 'S·ª≠a giao d·ªãch';
                    detailsHTML = `
                        <div class="log-details">
                            Ng√†y: ${log.details.date || 'N/A'}<br>
                            Thu: ${log.details.oldIn || 0} $ ‚Üí ${log.details.newIn || 0} $<br>
                            Chi: ${log.details.oldOut || 0} $ ‚Üí ${log.details.newOut || 0} $
                        </div>
                    `;
                    break;
                    
                case 'transaction_delete':
                    logClass += ' error';
                    icon = 'üóëÔ∏è';
                    actionText = 'X√≥a giao d·ªãch';
                    detailsHTML = `
                        <div class="log-details">
                            Ng√†y: ${log.details.date || 'N/A'}
                        </div>
                    `;
                    break;
                    
                default:
                    logClass += ' info';
                    icon = 'üìù';
                    actionText = log.action;
            }
            
            // Th√™m message n·∫øu c√≥
            if (log.details.message) {
                detailsHTML += `<div class="log-details">${log.details.message}</div>`;
            }
            
            logsHTML += `
                <div class="${logClass}">
                    <div class="log-time">
                        <span>${icon} ${dateStr} ${timeStr}</span>
                    </div>
                    <div class="log-action">${actionText}</div>
                    ${detailsHTML}
                </div>
            `;
        });
        
        logsList.innerHTML = logsHTML;
        
        // ·∫®n/hi·ªán n√∫t "T·∫£i th√™m"
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        if (loadMoreBtn) {
            if (window.logsOffset + window.logsLimit >= window.logsStore.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'block';
            }
        }
    }
    
    // T·∫£i th√™m logs
    window.loadMoreLogs = function() {
        window.logsOffset += window.logsLimit;
        renderLogs();
    };
    
    // X√≥a t·∫•t c·∫£ logs
    window.clearLogs = function() {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ logs? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) {
            window.logsStore = [];
            syncLogs();
            renderLogs();
            showStatus("üóëÔ∏è ƒê√£ x√≥a t·∫•t c·∫£ logs", 2000);
        }
    };

    // ========== EXPORT/IMPORT FUNCTIONS ==========
    window.exportToExcel = function() {
        if (!window.dataStore || Object.keys(window.dataStore).length === 0) {
            showStatus("‚ùå Ch∆∞a c√≥ d·ªØ li·ªáu!", 3000);
            return;
        }
        
        const { bank, mi11, k60, n7, alpha, rate } = window.configStore;
        
        // Calculate totals
        let tIn = 0, tOut = 0;
        for (let k in window.dataStore) {
            tIn += parseFloat(window.dataStore[k].in) || 0;
            tOut += parseFloat(window.dataStore[k].out) || 0;
        }
        
        const profit = tIn - tOut;
        const alphaTotalVND = (alpha + profit) * rate;
        const mainTotalVND = bank + (mi11 + k60 + n7) * rate;
        
        // Prepare data
        const data = [
            ["B√ÅO C√ÅO T√ÄI CH√çNH CHI TI·∫æT - QU·∫¢N L√ù T√ÄI CH√çNH ULTIMATE PRO"],
            ["Ng√†y xu·∫•t b√°o c√°o:", new Date().toLocaleDateString('vi-VN') + ' ' + new Date().toLocaleTimeString('vi-VN')],
            ["Ng∆∞·ªùi d√πng:", "Qu·∫£n tr·ªã vi√™n"],
            [],
            ["=== T·ªîNG QUAN T√ÄI CH√çNH ==="],
            ["T·ªïng s·ªë d∆∞ hi·ªán t·∫°i:", mainTotalVND, "VND"],
            ["T·ªïng t√†i s·∫£n Alpha:", alphaTotalVND, "VND"],
            ["L·ª£i nhu·∫≠n th√°ng:", profit, "USD"],
            ["L·ª£i nhu·∫≠n quy ƒë·ªïi:", profit * rate, "VND"],
            [],
            ["=== CHI TI·∫æT T√ÄI S·∫¢N ==="],
            ["Lo·∫°i t√†i s·∫£n", "S·ªë l∆∞·ª£ng", "ƒê∆°n v·ªã", "Quy ƒë·ªïi (VND)"],
            ["S·ªë d∆∞ ng√¢n h√†ng", bank, "VND", bank],
            ["USD Mi 11", mi11, "USD", mi11 * rate],
            ["USD K60", k60, "USD", k60 * rate],
            ["USD N7", n7, "USD", n7 * rate],
            ["V·ªën Alpha", alpha, "USD", alpha * rate],
            [],
            ["=== TH·ªêNG K√ä GIAO D·ªäCH ==="],
            ["T·ªïng thu:", tIn, "USD"],
            ["T·ªïng chi:", tOut, "USD"],
            ["T·ª∑ gi√° √°p d·ª•ng:", rate, "VND/USD"],
            [],
            ["=== CHI TI·∫æT GIAO D·ªäCH THEO NG√ÄY ==="],
            ["Ng√†y", "Thu ($)", "Chi ($)", "L·ª£i nhu·∫≠n ($)", "Quy ƒë·ªïi (VND)", "Ghi ch√∫"]
        ];
        
        // Sort dates
        const keys = Object.keys(window.dataStore).sort((a, b) => new Date(a) - new Date(b));
        
        keys.forEach(key => {
            const item = window.dataStore[key];
            const prof = (parseFloat(item.in) || 0) - (parseFloat(item.out) || 0);
            const note = prof > 0 ? "L√£i" : prof < 0 ? "L·ªó" : "H√≤a v·ªën";
            data.push([key, item.in || 0, item.out || 0, prof, prof * rate, note]);
        });
        
        // Add summary row
        data.push([]);
        data.push(["T·ªîNG C·ªòNG", tIn, tOut, profit, profit * rate, profit > 0 ? "L√ÉI" : "L·ªñ"]);
        
        // Create worksheet
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // Auto-size columns
        const wscols = [
            { wch: 12 }, // Date
            { wch: 10 }, // Income
            { wch: 10 }, // Expense
            { wch: 12 }, // Profit
            { wch: 15 }, // Converted
            { wch: 10 }  // Note
        ];
        ws['!cols'] = wscols;
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "BaoCaoTaiChinh");
        
        // Generate filename with date
        const dateStr = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(wb, `BaoCaoTaiChinh_${dateStr}.xlsx`);
        
        showStatus("üìä ƒê√£ xu·∫•t file Excel th√†nh c√¥ng!", 3000);
    }

    // ========== CHART FUNCTIONS ==========
    function updateChart() {
        const ctx = document.getElementById('monthlyChart').getContext('2d');
        
        // Get data for last 6 months
        const months = [];
        const incomeData = [];
        const expenseData = [];
        const profitData = [];
        
        const currentDate = new Date();
        
        for (let i = 5; i >= 0; i--) {
            const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
            const monthData = calcMonthlyProfitUSD(date.getFullYear(), date.getMonth() + 1);
            
            months.push(`${date.getMonth() + 1}/${date.getFullYear()}`);
            incomeData.push(monthData.income);
            expenseData.push(monthData.expense);
            profitData.push(monthData.profit);
        }
        
        // Destroy existing chart
        if (window.chart) {
            window.chart.destroy();
        }
        
        // Create new chart
        window.chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    {
                        label: 'Thu ($)',
                        data: incomeData,
                        backgroundColor: 'rgba(0, 184, 148, 0.7)',
                        borderColor: 'rgba(0, 184, 148, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Chi ($)',
                        data: expenseData,
                        backgroundColor: 'rgba(214, 48, 49, 0.7)',
                        borderColor: 'rgba(214, 48, 49, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'L√£i ($)',
                        data: profitData,
                        type: 'line',
                        borderColor: 'rgba(9, 132, 227, 1)',
                        backgroundColor: 'rgba(9, 132, 227, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + ' $';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' $';
                            }
                        }
                    }
                }
            }
        });
    }

    function updateYearSummary() {
        const currentYear = window.currentDate.getFullYear();
        document.getElementById('currentYear').innerText = currentYear;
        
        let totalIncome = 0;
        let totalExpense = 0;
        let monthsWithData = 0;
        
        const monthlyData = [];
        
        for (let month = 1; month <= 12; month++) {
            const monthData = calcMonthlyProfitUSD(currentYear, month);
            if (monthData.income > 0 || monthData.expense > 0) {
                monthsWithData++;
            }
            
            totalIncome += monthData.income;
            totalExpense += monthData.expense;
            
            monthlyData.push({
                month: month,
                income: monthData.income,
                expense: monthData.expense,
                profit: monthData.profit
            });
        }
        
        const totalProfit = totalIncome - totalExpense;
        const avgMonthlyProfit = monthsWithData > 0 ? totalProfit / monthsWithData : 0;
        
        let summaryHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="balance-label">T·ªîNG THU NƒÇM</div>
                    <div class="stat-value stat-in">${formatCurrency(totalIncome, 'USD')}</div>
                </div>
                <div class="stat-card">
                    <div class="balance-label">T·ªîNG CHI NƒÇM</div>
                    <div class="stat-value stat-out">${formatCurrency(totalExpense, 'USD')}</div>
                </div>
                <div class="stat-card">
                    <div class="balance-label">L√ÉI C·∫¢ NƒÇM</div>
                    <div class="stat-value stat-profit">${formatCurrency(totalProfit, 'USD')}</div>
                </div>
            </div>
            <div style="font-size: 12px; color: var(--text-sub);">
                <p>üìÖ <strong>${monthsWithData}</strong> th√°ng c√≥ d·ªØ li·ªáu</p>
                <p>üìä L√£i trung b√¨nh/th√°ng: <strong>${formatCurrency(avgMonthlyProfit, 'USD')}</strong></p>
            </div>
        `;
        
        document.getElementById('yearSummary').innerHTML = summaryHTML;
    }

    // ========== SETTINGS FUNCTIONS ==========
    window.switchTab = function(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Deactivate all tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        const tabElement = document.getElementById(tabName + 'Tab');
        if (tabElement) {
            tabElement.classList.add('active');
        }
        
        // Activate selected button
        event.target.classList.add('active');
        
        // Update chart if switching to analytics
        if (tabName === 'analytics') {
            setTimeout(() => {
                if (window.updateChart) updateChart();
                if (window.updateYearSummary) updateYearSummary();
            }, 100);
        }
        
        // Update logs if switching to logs tab
        if (tabName === 'logs') {
            setTimeout(() => {
                renderLogs();
            }, 100);
        }
    }

    window.clearMonthData = function() {
        const currentYear = window.currentDate.getFullYear();
        const currentMonth = window.currentDate.getMonth() + 1;
        
        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu c·ªßa th√°ng ${currentMonth}/${currentYear}?`)) {
            pushUndo();
            
            // ƒê·∫øm s·ªë giao d·ªãch s·∫Ω b·ªã x√≥a
            let deleteCount = 0;
            
            // Remove all entries for current month
            for (let key in window.dataStore) {
                const [year, month] = key.split('-').map(Number);
                if (year === currentYear && month === currentMonth) {
                    delete window.dataStore[key];
                    deleteCount++;
                }
            }
            
            // Ghi log
            addLog('system', {
                message: `X√≥a ${deleteCount} giao d·ªãch th√°ng ${currentMonth}/${currentYear}`
            });
            
            syncToCloud();
            updateCalculations();
            renderCal();
            updateChart();
            showStatus(`üóëÔ∏è ƒê√£ x√≥a ${deleteCount} giao d·ªãch th√°ng ${currentMonth}/${currentYear}`, 3000);
        }
    }

    window.restoreData = function() {
        if (confirm("Kh√¥i ph·ª•c d·ªØ li·ªáu m·∫´u? D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã thay th·∫ø.")) {
            pushUndo();
            
            // Ghi log kh√¥i ph·ª•c
            addLog('system', {
                message: 'Kh√¥i ph·ª•c d·ªØ li·ªáu m·∫´u'
            });
            
            createSampleData();
            updateCalculations();
            renderCal();
            updateChart();
            showStatus("üîÑ ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu m·∫´u", 3000);
        }
    }

    // ========== INITIALIZATION ==========
    function init() {
        // Initialize Firebase
        initFirebase();
        
        // Initial render
        setTimeout(() => {
            renderCal();
            updateCalculations();
        }, 1000);
        
        console.log("‚úÖ ·ª®ng d·ª•ng ƒë√£ kh·ªüi ƒë·ªông th√†nh c√¥ng!");
    }

    // Start the application
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>